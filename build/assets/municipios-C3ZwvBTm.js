import{r as s,j as t,C as Ee}from"./index-SVRFFNc9.js";import{S as c}from"./sweetalert2.esm.all-D3pEHXw3.js";import{C as p}from"./index.esm-DWwMdKxH.js";import{E as Ne}from"./jspdf.plugin.autotable-gke1D7B3.js";import{l as Te}from"./logo_saint_patrick-xw7Wl8f3.js";import{u as ve}from"./usePermission-BCWksQX7.js";import ke from"./AccessDenied-yaDW3Jao.js";import{C as k}from"./CContainer-BdNP0s3v.js";import{C as M,a as u}from"./CRow-Bf67u6lu.js";import{a as l}from"./CButton-D9GPTbB6.js";import{c as _e}from"./cil-plus-D8mtC-W5.js";import{c as De}from"./cil-file-CeQgYs_D.js";import{C as f}from"./CInputGroup-D-McUFva.js";import{C as _}from"./CInputGroupText-Cfu0fzaY.js";import{c as Pe}from"./cil-search-CDkY_4k-.js";import{C as B}from"./CFormInput-B_gylY64.js";import{C as H}from"./CFormSelect-CzT7g5tb.js";import{C as ze,a as Le,b as O,c as S,d as Fe,e as E}from"./CTable-98qqrSRH.js";import{c as Ie}from"./cil-pen-53d2I-C-.js";import{c as Ae}from"./cil-trash-CBbKHhHb.js";import{C as Re}from"./CPagination-UopCEeNZ.js";import{C as Ue,a as $e,b as Be,c as He}from"./CModalHeader-Bhtr3bZe.js";import{C as Oe}from"./CModalTitle-M2mBvD_5.js";import{C as Ge}from"./CForm-CYRkMwLo.js";import{c as qe}from"./cil-save-CHBg7z_U.js";import"./CFormControlWrapper-OEJgTi6e.js";import"./CFormControlValidation-CtDkyDfm.js";import"./CFormLabel-szm2Dda9.js";import"./CBackdrop-BbuVwMMD.js";import"./CConditionalPortal-DwBsYzTA.js";const Mt=()=>{const{canSelect:G,canUpdate:q,canDelete:V,canInsert:W}=ve("Municipios"),[g,Y]=s.useState([]),[J,Z]=s.useState([]),[K,Q]=s.useState(!0),[D,X]=s.useState(""),[C,ee]=s.useState(""),[N,P]=s.useState([]),[d,b]=s.useState(0),[h,te]=s.useState(5),[oe,m]=s.useState(!1),[T,z]=s.useState(!1),[j,y]=s.useState({codMunicipio:null,nombreMunicipio:"",codDepartamento:""}),w=async()=>{try{const e=await fetch("http://localhost:4000/api/departamento/municipios"),r=await e.json();if(e.ok){const n=r.map(o=>({...o,nombre:o.nombre?o.nombre.toUpperCase():o.nombre}));Y(n),P(n)}else throw new Error(r.message||"Error al obtener los municipios")}catch(e){X(e.message),c.fire("Error",e.message,"error")}finally{Q(!1)}},re=async()=>{try{const e=await fetch("http://localhost:4000/api/departamento/departamentos"),r=await e.json();if(e.ok){const n=r.map(o=>({...o,nombre:o.nombre?o.nombre.toUpperCase():o.nombre}));Z(n)}else throw new Error("Error al obtener los departamentos")}catch(e){console.error("Error:",e),c.fire("Error","Error al cargar los departamentos","error")}},[L,i]=s.useState(""),ne=async()=>{const{nombreMunicipio:e,codDepartamento:r}=j;if(!e||!r){i("Todos los campos son requeridos");return}if(g.some(o=>o.nombre_municipio.toLowerCase()===e.toLowerCase())){i("Ya existe un municipio con ese nombre");return}else i("");try{const o=await fetch("http://localhost:4000/api/departamento/municipios",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nombre_municipio:e,cod_departamento:r})});if(o.ok)c.fire("Éxito","Municipio creado exitosamente","success"),w();else{const a=await o.json();throw new Error(a.message||"Error al crear el municipio")}}catch(o){c.fire("Error",o.message,"error")}finally{m(!1),i("")}},F=e=>{e.preventDefault(),i("Copiar y pegar no está permitido."),setTimeout(()=>i(""),5e3)},ie=e=>/([a-zA-Z])\1\1/.test(e),se=e=>/^[a-zA-Z0-9\s]*$/.test(e),ae=e=>/\d/.test(e),ce=e=>/\s{3,}/.test(e),I=e=>{const{name:r,value:n}=e.target,o=n.toUpperCase();if(i(""),r==="nombreMunicipio"){if(!o.trim()){y(a=>({...a,[r]:o}));return}if(ie(o.replace(/\s/g,""))){i("No se permiten más de 2 letras consecutivas iguales"),setTimeout(()=>i(""),5e3);return}if(!se(o)){i("No se permiten caracteres especiales"),setTimeout(()=>i(""),5e3);return}if(ae(o)){i("No se permiten números."),setTimeout(()=>i(""),5e3);return}if(ce(o)){i("No se permiten más de 2 espacios consecutivos"),setTimeout(()=>i(""),5e3);return}}y(a=>({...a,[r]:o}))},le=async()=>{const{codMunicipio:e,nombreMunicipio:r,codDepartamento:n}=j;if(!r||!n){c.fire("Error","Todos los campos son requeridos","error");return}try{const o=await fetch(`http://localhost:4000/api/departamento/municipios/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({nombre_municipio:r,cod_departamento:n})});if(o.ok)c.fire("Éxito","Municipio actualizado exitosamente","success"),w();else{const a=await o.json();throw new Error(a.message||"Error al actualizar el municipio")}}catch(o){c.fire("Error",o.message,"error")}finally{m(!1)}},de=async e=>{try{if((await fetch(`http://localhost:4000/api/departamento/municipios/${e}`,{method:"DELETE"})).ok)c.fire("Éxito","Municipio eliminado correctamente","success"),w();else throw new Error("Error al eliminar el municipio")}catch(r){c.fire("Error",r.message,"error")}},me=e=>{c.fire({title:"¿Estás seguro?",text:"No podrás revertir esta acción",icon:"warning",showCancelButton:!0,confirmButtonText:"Eliminar",cancelButtonText:"Cancelar"}).then(r=>{r.isConfirmed&&de(e)})},pe=e=>{const r=e.target.value.toLowerCase();ee(r);const n=g.filter(o=>o.nombre_municipio.toLowerCase().includes(r)||o.nombre_departamento.toLowerCase().includes(r));P(n),b(0)},ue=()=>{y({codMunicipio:null,nombreMunicipio:"",codDepartamento:""}),z(!1),m(!0)},he=e=>{y({codMunicipio:e.cod_municipio,nombreMunicipio:e.nombre_municipio,codDepartamento:e.cod_departamento}),z(!0),m(!0)},xe=e=>{e.preventDefault(),T?le():ne()},fe=()=>{const e=new Ne({orientation:"landscape",unit:"mm",format:"a4"}),r=new Image;r.src=Te,r.onload=()=>{const n=e.internal.pageSize.width,o=e.internal.pageSize.height;e.addImage(r,"PNG",10,10,45,45),e.setFontSize(18),e.setTextColor(0,102,51),e.text("SAINT PATRICK'S ACADEMY",n/2,24,{align:"center"}),e.setFontSize(10),e.setTextColor(100),e.text("Casa Club del periodista, Colonia del Periodista",n/2,32,{align:"center"}),e.text("Teléfono: (504) 2234-8871",n/2,37,{align:"center"}),e.text("Correo: info@saintpatrickacademy.edu",n/2,42,{align:"center"}),e.setFontSize(14),e.setTextColor(0,102,51),e.text("Reporte de Municipios",n/2,50,{align:"center"}),e.setLineWidth(.5),e.setDrawColor(0,102,51),e.line(10,55,n-10,55),e.setFontSize(12),e.setTextColor(0),e.text("Listado de Municipios",n/2,65,{align:"center"});let a=g;C&&C.trim()!==""&&(a=g.filter(x=>x.nombre_departamento.toLowerCase().includes(C.toLowerCase())));const be=["#","Municipio","Departamento"],je=a.map((x,v)=>[{content:(v+1).toString(),styles:{halign:"center"}},{content:x.nombre_municipio.toUpperCase(),styles:{halign:"left"}},{content:x.nombre_departamento.toUpperCase(),styles:{halign:"center"}}]);e.autoTable({startY:75,head:[be],body:je,headStyles:{fillColor:[0,102,51],textColor:[255,255,255],fontSize:10,halign:"center"},styles:{fontSize:10,cellPadding:3},alternateRowStyles:{fillColor:[240,248,255]},columnStyles:{0:{halign:"center"},1:{halign:"center"}},margin:{top:10,bottom:30},didDrawPage:function(x){const v=e.internal.getNumberOfPages(),we=e.internal.getCurrentPageInfo().pageNumber;e.setFontSize(10),e.setTextColor(0,102,51),e.text(`Página ${we} de ${v}`,n-10,o-10,{align:"right"});const $=new Date,Me=$.toLocaleDateString("es-HN",{year:"numeric",month:"long",day:"numeric"}),Se=$.toLocaleTimeString("es-HN",{hour:"2-digit",minute:"2-digit",second:"2-digit"});e.text(`Fecha de generación: ${Me} Hora: ${Se}`,10,o-10)}});const ye=e.output("blob"),U=URL.createObjectURL(ye);window.open("","_blank").document.write(`
        <html>
          <head><title>Reporte de Municipios</title></head>
          <body style="margin:0;">
            <iframe width="100%" height="100%" src="${U}" frameborder="0"></iframe>
            <div style="position:fixed;top:10px;right:200px;">
              <button style="background-color: #6c757d; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;" 
                onclick="const a = document.createElement('a'); a.href='${U}'; a.download='Reporte_de_Municipios.pdf'; a.click();">
                Descargar PDF
              </button>
            </div>
          </body>
        </html>`)},r.onerror=()=>{swal.fire("Error","No se pudo cargar el logo.","error")}};s.useEffect(()=>{w(),re()},[]);const A=(d+1)*h,ge=A-h,Ce=N.slice(ge,A);if(K)return t.jsx(k,{children:t.jsx(M,{className:"justify-content-center",children:t.jsxs(u,{xs:12,md:6,children:[t.jsx(Ee,{color:"primary"}),t.jsx("p",{children:"Cargando municipios..."})]})})});if(D)return t.jsx(k,{children:t.jsx(M,{className:"justify-content-center",children:t.jsx(u,{xs:12,md:6,children:t.jsxs("p",{children:["Error: ",D]})})})});const R=Math.ceil(N.length/h);return G?t.jsxs(k,{children:[t.jsxs(M,{className:"justify-content-between align-items-center mb-3 sticky-header",children:[t.jsx(u,{xs:12,md:8,children:t.jsx("h3",{children:"Mantenimiento de Municipios"})}),t.jsxs(u,{xs:"4",md:"3",className:"text-end",children:[W&&t.jsxs(l,{color:"dark",onClick:ue,className:"me-2",style:{backgroundColor:"#4B6251",borderColor:"#0F463A"},children:[t.jsx(p,{icon:_e})," Nuevo"]}),t.jsxs(l,{color:"primary",onClick:fe,style:{backgroundColor:"#6C8E58",borderColor:"#617341"},children:[t.jsx(p,{icon:De})," Generar Reporte"]})]})]}),t.jsxs(M,{className:"align-items-center my-3 sticky-header",children:[t.jsx(u,{md:5,children:t.jsxs(f,{size:"sm",children:[t.jsx(_,{children:t.jsx(p,{icon:Pe})}),t.jsx(B,{placeholder:"Buscar municipio",value:C,onChange:pe})]})}),t.jsx(u,{xs:"12",md:"7",className:"text-md-end mt-2 mt-md-0",children:t.jsx(f,{style:{width:"auto",display:"inline-block"},children:t.jsxs("div",{className:"d-inline-flex align-items-center",children:[t.jsx("span",{children:"Mostrar "}),t.jsxs(H,{style:{width:"80px",display:"inline-block",textAlign:"center"},onChange:e=>{te(Number(e.target.value)),b(0)},value:h,children:[t.jsx("option",{value:"5",children:"5"}),t.jsx("option",{value:"10",children:"10"}),t.jsx("option",{value:"20",children:"20"})]}),t.jsx("span",{children:" registros"})]})})})]}),t.jsx("div",{className:"table-container",children:t.jsxs(ze,{striped:!0,bordered:!0,hover:!0,children:[t.jsx(Le,{children:t.jsxs(O,{children:[t.jsx(S,{children:"#"}),t.jsx(S,{children:"Nombre del Municipio"}),t.jsx(S,{children:"Departamento"}),t.jsx(S,{className:"text-end",children:"Acciones"})]})}),t.jsx(Fe,{children:Ce.map((e,r)=>t.jsxs(O,{children:[t.jsx(E,{children:r+1+d*h}),t.jsx(E,{children:e.nombre_municipio.toUpperCase()}),t.jsx(E,{children:e.nombre_departamento.toUpperCase()}),t.jsxs(E,{className:"text-end",children:[q&&t.jsx(l,{color:"warning",size:"sm",style:{opacity:.8},onClick:()=>he(e),children:t.jsx(p,{icon:Ie})})," ",V&&t.jsx(l,{color:"danger",size:"sm",style:{opacity:.8},onClick:()=>me(e.cod_municipio),children:t.jsx(p,{icon:Ae})})]})]},e.cod_municipio))})]})}),t.jsxs("nav",{className:"d-flex justify-content-center align-items-center mt-4",children:[t.jsxs(Re,{className:"mb-0",style:{gap:"0.3cm"},children:[t.jsx(l,{style:{backgroundColor:"gray",color:"white",marginRight:"0.3cm"},disabled:d===0,onClick:()=>b(d-1),children:"Anterior"}),t.jsx(l,{style:{backgroundColor:"gray",color:"white"},disabled:d===R-1,onClick:()=>b(d+1),children:"Siguiente"})]}),t.jsxs("span",{className:"mx-2",children:["Página ",d+1," de ",R]})]}),t.jsxs(Ue,{visible:oe,onClose:()=>m(!1),backdrop:"static",children:[t.jsx($e,{closeButton:!0,children:t.jsx(Oe,{children:T?"Editar Municipio":"Agregar Municipio"})}),t.jsx(Be,{children:t.jsxs(Ge,{onSubmit:xe,children:[t.jsx(f,{className:"mb-3",children:t.jsxs(f,{children:[t.jsx(_,{children:"Nombre del Municipio"}),t.jsx(B,{type:"text",name:"nombreMunicipio",onPaste:F,onCopy:F,placeholder:"Nombre del municipio",value:j.nombreMunicipio||"",onChange:I,required:!0,style:{width:"50%",padding:"8px"}}),L&&t.jsx("div",{style:{color:"red",fontSize:"14px",marginTop:"5px"},children:L})]})}),t.jsxs(f,{className:"mb-3",children:[t.jsx(_,{children:"Departamento"}),t.jsxs(H,{name:"codDepartamento",value:j.codDepartamento,onChange:I,required:!0,children:[t.jsx("option",{value:"",children:"Seleccione un departamento"}),J.filter((e,r,n)=>r===n.findIndex(o=>o.cod_departamento===e.cod_departamento)).sort((e,r)=>e.nombre_departamento.localeCompare(r.nombre_departamento)).map(e=>t.jsx("option",{value:e.cod_departamento,children:e.nombre_departamento.toUpperCase()},`select-dept-${e.cod_departamento}-${e.nombre_departamento}`))]})]}),t.jsxs(He,{children:[t.jsx(l,{color:"secondary",onClick:()=>m(!1),children:"Cancelar"}),t.jsxs(l,{style:{backgroundColor:"#617341",color:"white"},type:"submit",children:[t.jsx(p,{icon:qe})," ","Guardar"]})]})]})})]}),t.jsx("style",{jsx:!0,children:`
        .table-container {
          max-height: 400px;
          overflow-y: ${N.length>=5?"auto":"hidden"};
          overflow-x: hidden;
        }
      `})]}):t.jsx(ke,{})};export{Mt as default};
