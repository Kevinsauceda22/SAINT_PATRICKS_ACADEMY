import{r as d,x as _e,j as r,h as F}from"./index-SVRFFNc9.js";import{C as m}from"./index.esm-DWwMdKxH.js";import{S as t}from"./sweetalert2.esm.all-D3pEHXw3.js";import{u as ve}from"./usePermission-BCWksQX7.js";import ze from"./AccessDenied-yaDW3Jao.js";import{l as De}from"./logo_saint_patrick-xw7Wl8f3.js";import{E as Re}from"./jspdf.plugin.autotable-gke1D7B3.js";import{u as y,w as Ae}from"./xlsx-lwdk4T0U.js";import{C as Be}from"./CContainer-BdNP0s3v.js";import{C as re,a as z}from"./CRow-Bf67u6lu.js";import{a as c}from"./CButton-D9GPTbB6.js";import{c as Me}from"./cil-plus-D8mtC-W5.js";import{C as Fe,a as $e,b as Le,c as oe}from"./CDropdownToggle-DlfIUTmX.js";import{c as Ie}from"./cil-description-MUzg6O3n.js";import{c as Oe}from"./cil-file-CeQgYs_D.js";import{c as Ue}from"./cil-spreadsheet-CJUvf_vM.js";import{C as D}from"./CInputGroup-D-McUFva.js";import{C as $}from"./CInputGroupText-Cfu0fzaY.js";import{c as He}from"./cil-search-CDkY_4k-.js";import{C as L}from"./CFormInput-B_gylY64.js";import{c as Je}from"./cil-brush-alt-CV61lKqC.js";import{C as Ve}from"./CFormSelect-CzT7g5tb.js";import{C as We,a as Ge,b as ae,c as I,d as qe,e as O}from"./CTable-98qqrSRH.js";import{c as te}from"./cil-pen-53d2I-C-.js";import{c as se}from"./cil-trash-CBbKHhHb.js";import{C as Ye}from"./CPagination-UopCEeNZ.js";import{C as U,a as H,b as J,c as V}from"./CModalHeader-Bhtr3bZe.js";import{C as W}from"./CModalTitle-M2mBvD_5.js";import{C as ie}from"./CForm-CYRkMwLo.js";import{c as Ze}from"./cil-save-CHBg7z_U.js";import"./CConditionalPortal-DwBsYzTA.js";import"./CFormControlWrapper-OEJgTi6e.js";import"./CFormControlValidation-CtDkyDfm.js";import"./CFormLabel-szm2Dda9.js";import"./CBackdrop-BbuVwMMD.js";const Ar=()=>{const{canSelect:ne,loading:Ke,error:Qe,canDelete:le,canInsert:ce,canUpdate:de}=ve("ListaParciales"),[h,pe]=d.useState([]),[ue,w]=d.useState(!1),[me,k]=d.useState(!1),[he,S]=d.useState(!1),[b,G]=d.useState({Nombre_parcial:""}),[g,R]=d.useState({}),[A,q]=d.useState({}),[Y,Z]=d.useState(""),E=d.useRef(null),[C,N]=d.useState(1),[j,ge]=d.useState(5),[fe,x]=d.useState(!1),B=()=>G({Nombre_parcial:""}),M=()=>R({Nombre_parcial:""});d.useEffect(()=>{T();const e=localStorage.getItem("token");if(e)try{const o=_e(e);console.log("Token decodificado:",o)}catch(o){console.error("Error al decodificar el token:",o)}},[]);const T=async()=>{try{const a=(await(await fetch("http://localhost:4000/api/parciales/verParciales")).json()).map((s,i)=>({...s,originalIndex:i+1}));pe(a)}catch(e){console.error("Error al obtener los parciales:",e)}},xe=()=>b.trim()?h.some(o=>o.Nombre_parcial.trim().toLowerCase()===b.trim().toLowerCase())?(t.fire("Error",`El parcial "${b}" ya existe`,"error"),!1):!0:(t.fire("Error",'El campo "Nombre del Parcial" no puede estar vacío',"error"),!1),be=()=>g.Nombre_parcial.trim()?h.some(o=>o.Nombre_parcial.trim().toLowerCase()===g.Nombre_parcial.trim().toLowerCase()&&o.Cod_parcial!==g.Cod_parcial)?(t.fire("Error",`El parcial "${g.Nombre_parcial}" ya existe`,"error"),!1):!0:(t.fire("Error",'El campo "Nombre del Parcial" no puede estar vacío',"error"),!1),K=(e,o)=>{const a=e.target,s=a.selectionStart;let i=a.value.toUpperCase().trimStart();const f=/^[A-ZÑÁÉÍÓÚ0-9\s,]*$/;if(/\s{2,}/.test(i)&&(t.fire({icon:"warning",title:"Espacios múltiples",text:"No se permite más de un espacio entre palabras."}),i=i.replace(/\s+/g," ")),!f.test(i)){t.fire({icon:"warning",title:"Caracteres no permitidos",text:"Solo se permiten letras y espacios."});return}const n=i.split(" ");for(let l of n){const u={};for(let p of l)if(u[p]=(u[p]||0)+1,u[p]>4){t.fire({icon:"warning",title:"Repetición de letras",text:`La letra "${p}" se repite más de 4 veces en la palabra "${l}".`});return}}a.value=i,o(i),x(!0),requestAnimationFrame(()=>{E.current&&E.current.setSelectionRange(s,s)})},P=e=>{e.preventDefault(),t.fire({icon:"warning",title:"Acción bloqueada",text:"Copiar y pegar no está permitido."})},_=(e,o)=>{fe?t.fire({title:"¿Estás seguro?",text:"Si cierras este formulario, perderás todos los datos ingresados.",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, cerrar",cancelButtonText:"Cancelar"}).then(a=>{a.isConfirmed&&(e(!1),o(),x(!1))}):(e(!1),o(),x(!1))},Ce=async()=>{if(xe())try{const e=localStorage.getItem("token");if(!e){t.fire("Error","No tienes permiso para realizar esta acción","error");return}const o=F(e);if(!o.cod_usuario||!o.nombre_usuario)throw console.error("No se pudo obtener el código o el nombre de usuario del token"),new Error("No se pudo obtener el código o el nombre de usuario del token");if((await fetch("http://localhost:4000/api/parciales/crearParcial",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({Nombre_parcial:b})})).ok){const s=`El usuario: ${o.nombre_usuario} ha creado nuevo parcial: ${b} `;(await fetch("http://localhost:4000/api/bitacora/registro",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({cod_usuario:o.cod_usuario,cod_objeto:57,accion:"INSERT",descripcion:s})})).ok?console.log("Registro en bitácora exitoso"):t.fire("Error","No se pudo registrar la acción en la bitácora","error"),T(),w(!1),B(),x(!1),t.fire({title:"¡Éxito!",text:"El parcial se ha creado correctamente.",icon:"success",confirmButtonText:"Aceptar"})}else t.fire("Error","Hubo un problema al crear el parcial","error")}catch{t.fire("Error","Hubo un problema al crear el parcial","error")}},je=async()=>{if(be())try{const e=localStorage.getItem("token");if(!e){t.fire("Error","No tienes permiso para realizar esta acción","error");return}const o=F(e);if(!o.cod_usuario||!o.nombre_usuario)throw console.error("No se pudo obtener el código o el nombre de usuario del token"),new Error("No se pudo obtener el código o el nombre de usuario del token");if((await fetch("http://localhost:4000/api/parciales/actualizarParcial",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({Cod_parcial:g.Cod_parcial,Nombre_parcial:g.Nombre_parcial})})).ok){const s=`El usuario: ${o.nombre_usuario} ha actualizado el parcial a: ${g.Nombre_parcial}`;(await fetch("http://localhost:4000/api/bitacora/registro",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({cod_usuario:o.cod_usuario,cod_objeto:57,accion:"UPDATE",descripcion:s})})).ok?console.log("Registro en bitácora exitoso"):t.fire("Error","No se pudo registrar la acción en la bitácora","error"),T(),k(!1),M(),x(!1),t.fire({title:"¡Éxito!",text:"El parcial se ha actualizado correctamente.",icon:"success",confirmButtonText:"Aceptar"})}else t.fire("Error","Hubo un problema al actualizar el parcial","error")}catch{t.fire("Error","Hubo un problema al actualizar el parcial","error")}},ye=async()=>{try{const e=localStorage.getItem("token");if(!e){t.fire("Error","No tienes permiso para realizar esta acción","error");return}const o=F(e);if(!o.cod_usuario||!o.nombre_usuario)throw console.error("No se pudo obtener el código o el nombre de usuario del token"),new Error("No se pudo obtener el código o el nombre de usuario del token");if((await fetch("http://localhost:4000/api/parciales/eliminar_parcial",{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({Cod_parcial:A.Cod_parcial})})).ok){const s=`El usuario: ${o.nombre_usuario} ha eliminado el parcial con código: ${A.Cod_parcial}`;(await fetch("http://localhost:4000/api/bitacora/registro",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({cod_usuario:o.cod_usuario,cod_objeto:57,accion:"DELETE",descripcion:s})})).ok?console.log("Registro en bitácora exitoso"):t.fire("Error","No se pudo registrar la acción en la bitácora","error"),T(),S(!1),q({}),t.fire({icon:"success",title:"¡Éxito!",text:"El parcial se ha eliminado correctamente",confirmButtonText:"Aceptar"})}else t.fire("Error","Hubo un problema al eliminar el parcial","error")}catch{t.fire("Error","Hubo un problema al eliminar el parcial","error")}},we=e=>{R(e),k(!0),x(!1)},ke=e=>{q(e),S(!0)},Se=e=>{let a=e.target.value.toUpperCase().trimStart();const s=/^[A-ZÑÁÉÍÓÚ0-9\s,]*$/;if(/\s{2,}/.test(a)&&(t.fire({icon:"warning",title:"Espacios múltiples",text:"No se permite más de un espacio entre palabras."}),a=a.replace(/\s+/g," ")),!s.test(a)){t.fire({icon:"warning",title:"Caracteres no permitidos",text:"Solo se permiten letras, números y espacios."});return}const i=a.split(" ");for(let f of i){const n={};for(let l of f)if(n[l]=(n[l]||0)+1,n[l]>4){t.fire({icon:"warning",title:"Repetición de letras",text:`La letra "${l}" se repite más de 4 veces en la palabra "${f}".`});return}}Z(a),N(1)},v=h.filter(e=>e.Nombre_parcial.toLowerCase().includes(Y.toLowerCase())),Q=C*j,Ee=Q-j,Ne=v.slice(Ee,Q),X=e=>{e>0&&e<=Math.ceil(v.length/j)&&N(e)};if(!ne)return r.jsx(ze,{});const Te=()=>{if(!h||h.length===0){t.fire({icon:"info",title:"Tabla vacía",text:"No hay datos disponibles para generar el reporte.",confirmButtonText:"Aceptar"});return}const e=new Re,o=new Image;o.src=De,o.onload=()=>{e.addImage(o,"PNG",10,10,30,30);let a=20;e.setFontSize(18),e.setTextColor(0,102,51),e.text("SAINT PATRICK'S ACADEMY",e.internal.pageSize.width/2,a,{align:"center"}),a+=12,e.setFontSize(16),e.text("Reporte de Parciales",e.internal.pageSize.width/2,a,{align:"center"}),a+=10,e.setFontSize(10),e.setTextColor(100),e.text("Casa Club del periodista, Colonia del Periodista",e.internal.pageSize.width/2,a,{align:"center"}),a+=4,e.text("Teléfono: (504) 2234-8871",e.internal.pageSize.width/2,a,{align:"center"}),a+=4,e.text("Correo: info@saintpatrickacademy.edu",e.internal.pageSize.width/2,a,{align:"center"}),a+=6,e.setLineWidth(.5),e.setDrawColor(0,102,51),e.line(10,a,e.internal.pageSize.width-10,a);const s=e.internal.pageSize.height;e.autoTable({startY:a+4,head:[["#","Nombre Parcial"]],body:h.map((n,l)=>[l+1,`${n.Nombre_parcial||""}`.trim()]),headStyles:{fillColor:[0,102,51],textColor:[255,255,255],fontSize:10},styles:{fontSize:10,cellPadding:3,halign:"center"},columnStyles:{0:{cellWidth:"auto"},1:{cellWidth:"auto"}},alternateRowStyles:{fillColor:[240,248,255]},didDrawPage:n=>{const l=new Date,u=`${l.toLocaleDateString()} ${l.toLocaleTimeString()}`,p=e.internal.pageSize.height;e.setFontSize(10),e.setTextColor(100),e.text(`Fecha y hora de generación: ${u}`,10,p-10)}});const i=e.internal.getNumberOfPages(),f=e.internal.pageSize.width;for(let n=1;n<=i;n++){e.setPage(n),e.setTextColor(100);const l=`Página ${n} de ${i}`;e.text(l,f-30,s-10)}window.open(e.output("bloburl"),"_blank")},o.onerror=()=>{console.warn("No se pudo cargar el logo. El PDF se generará sin el logo."),window.open(e.output("bloburl"),"_blank")}},Pe=()=>{if(!h||h.length===0){t.fire({icon:"info",title:"Tabla vacía",text:"No hay datos disponibles para generar el reporte excel.",confirmButtonText:"Aceptar"});return}const e=[["Saint Patrick Academy"],["Reporte de Parciales"],[],["#","Nombre Parcial"]],o=h.map((u,p)=>[p+1,u.Nombre_parcial]),a=[...e,...o],s=y.aoa_to_sheet(a),i=y.decode_range(s["!ref"]);for(let u=0;u<=3;u++)for(let p=i.s.c;p<=i.e.c;p++){const ee=y.encode_cell({r:u,c:p});s[ee]&&(s[ee].s={font:{bold:!0,sz:14,color:{rgb:"FFFFFF"}},fill:{fgColor:{rgb:"15401D"}},alignment:{horizontal:"center"}})}const f=[{wpx:100},{wpx:100}];s["!cols"]=f;const n=y.book_new();y.book_append_sheet(n,s,"Reporte de Estados Nota"),Ae(n,"Reporte_Estados_Nota.xlsx")};return r.jsxs(Be,{children:[r.jsxs(re,{className:"align-items-center mb-5",children:[r.jsx(z,{xs:"12",md:"9",children:r.jsx("h1",{className:"mb-0",children:"Mantenimiento Parciales"})}),r.jsxs(z,{xs:"12",md:"3",className:"text-end d-flex flex-column flex-md-row justify-content-md-end align-items-md-center mt-3 mt-md-0",children:[ce&&r.jsxs(c,{className:"mb-3 mb-md-0 me-md-3 gap-1 rounded shadow",style:{backgroundColor:"#4B6251",color:"white",transition:"all 0.3s ease",height:"40px",width:"auto",minWidth:"100px",padding:"0 16px",fontSize:"16px",display:"flex",alignItems:"center",justifyContent:"center"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="#3C4B43",e.currentTarget.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="#4B6251",e.currentTarget.style.boxShadow="none"},onClick:()=>{w(!0),x(!1)},children:[r.jsx(m,{icon:Me})," Nuevo"]}),r.jsxs(Fe,{className:"btn-sm d-flex align-items-center gap-1 rounded shadow",children:[r.jsxs($e,{style:{backgroundColor:"#6C8E58",color:"white",cursor:"pointer",transition:"all 0.3s ease"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="#5A784C",e.currentTarget.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="#6C8E58",e.currentTarget.style.boxShadow="none"},children:[r.jsx(m,{icon:Ie})," Reporte"]}),r.jsxs(Le,{style:{position:"absolute",zIndex:1050,backgroundColor:"#fff",boxShadow:"0px 2px 8px rgba(0, 0, 0, 0.2)",borderRadius:"4px",overflow:"hidden"},children:[r.jsxs(oe,{onClick:Te,style:{cursor:"pointer",outline:"none",backgroundColor:"transparent",padding:"0.5rem 1rem",fontSize:"0.85rem",color:"#333",borderBottom:"1px solid #eaeaea",transition:"background-color 0.1s"},onMouseOver:e=>e.target.style.backgroundColor="#f5f5f5",onMouseOut:e=>e.target.style.backgroundColor="transparent",children:[r.jsx(m,{icon:Oe,size:"sm"})," Abrir en PDF"]}),r.jsxs(oe,{onClick:Pe,style:{cursor:"pointer",outline:"none",backgroundColor:"transparent",padding:"0.5rem 1rem",fontSize:"0.85rem",color:"#333",transition:"background-color 0.3s"},onMouseOver:e=>e.target.style.backgroundColor="#f5f5f5",onMouseOut:e=>e.target.style.backgroundColor="transparent",children:[r.jsx(m,{icon:Ue,size:"sm"})," Descargar Excel"]})]})]})]})]}),r.jsxs(re,{className:"align-items-center mt-4 mb-2",children:[r.jsx(z,{xs:"12",md:"8",className:"d-flex flex-wrap align-items-center",children:r.jsxs(D,{className:"me-3",style:{width:"400px"},children:[r.jsx($,{children:r.jsx(m,{icon:He})}),r.jsx(L,{placeholder:"Buscar parcial...",onChange:Se,value:Y}),r.jsxs(c,{style:{border:"1px solid #ccc",transition:"all 0.1s ease-in-out",backgroundColor:"#F3F4F7",color:"#343a40"},onClick:()=>{Z(""),N(1)},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="#E0E0E0",e.currentTarget.style.color="black"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="#F3F4F7",e.currentTarget.style.color="#343a40"},children:[r.jsx(m,{icon:Je})," Limpiar"]})]})}),r.jsx(z,{xs:"12",md:"4",className:"text-md-end mt-2 mt-md-0",children:r.jsx(D,{className:"mt-2 mt-md-0",style:{width:"auto",display:"inline-block"},children:r.jsxs("div",{className:"d-inline-flex align-items-center",children:[r.jsx("span",{children:"Mostrar "}),r.jsxs(Ve,{style:{width:"80px",display:"inline-block",textAlign:"center"},onChange:e=>{const o=Number(e.target.value);ge(o),N(1)},value:j,children:[r.jsx("option",{value:"5",children:"5"}),r.jsx("option",{value:"10",children:"10"}),r.jsx("option",{value:"20",children:"20"})]}),r.jsx("span",{children:" registros"})]})})})]}),r.jsx("div",{className:"table-container",style:{maxHeight:"400px",overflowY:"scroll",marginBottom:"20px"},children:r.jsxs(We,{striped:!0,bordered:!0,hover:!0,children:[r.jsx(Ge,{children:r.jsxs(ae,{children:[r.jsx(I,{children:"#"}),r.jsx(I,{children:"Nombre del Parcial"}),r.jsx(I,{children:"Acciones"})]})}),r.jsx(qe,{children:Ne.map(e=>r.jsxs(ae,{children:[r.jsx(O,{children:e.originalIndex}),r.jsx(O,{children:e.Nombre_parcial}),r.jsxs(O,{children:[de&&r.jsx(c,{style:{backgroundColor:"#F9B64E",marginRight:"10px"},onClick:()=>we(e),children:r.jsx(m,{icon:te})}),le&&r.jsx(c,{style:{backgroundColor:"#E57368",marginRight:"10px"},onClick:()=>ke(e),children:r.jsx(m,{icon:se})})]})]},e.Cod_parcial))})]})}),r.jsxs("div",{className:"pagination-container",style:{display:"flex",justifyContent:"center",alignItems:"center"},children:[r.jsxs(Ye,{"aria-label":"Page navigation",children:[r.jsx(c,{style:{backgroundColor:"#6f8173",color:"#D9EAD3"},disabled:C===1,onClick:()=>X(C-1),children:"Anterior"}),r.jsx(c,{style:{marginLeft:"10px",backgroundColor:"#6f8173",color:"#D9EAD3"},disabled:C===Math.ceil(v.length/j),onClick:()=>X(C+1),children:"Siguiente"})]}),r.jsxs("span",{style:{marginLeft:"10px"},children:["Página ",C," de ",Math.ceil(v.length/j)]})]}),r.jsxs(U,{visible:ue,backdrop:"static",children:[r.jsxs(H,{closeButton:!1,children:[r.jsx(W,{children:"Nuevo Parcial"}),r.jsx(c,{className:"btn-close","aria-label":"Close",onClick:()=>_(w,B)})]}),r.jsx(J,{children:r.jsx(ie,{children:r.jsxs(D,{className:"mb-3",children:[r.jsx($,{children:"Nombre del Parcial"}),r.jsx(L,{ref:E,type:"text",value:b.Nombre_parcial,maxLength:20,placeholder:"Ingrese el nombre del parcial",onPaste:P,onCopy:P,onChange:e=>K(e,G)})]})})}),r.jsxs(V,{children:[r.jsx(c,{color:"secondary",onClick:()=>_(w,B),children:"Cancelar"}),r.jsxs(c,{style:{backgroundColor:"#4B6251",color:"white"},onClick:Ce,onMouseEnter:e=>e.currentTarget.style.backgroundColor="#3C4B43",onMouseLeave:e=>e.currentTarget.style.backgroundColor="#4B6251",children:[r.jsx(m,{icon:Ze,style:{marginRight:"5px"}})," Guardar"]})]})]}),r.jsxs(U,{visible:me,backdrop:"static",children:[r.jsxs(H,{closeButton:!1,children:[r.jsx(W,{children:"Actualizar Parcial"}),r.jsx(c,{className:"btn-close","aria-label":"Close",onClick:()=>_(k,M)})]}),r.jsx(J,{children:r.jsx(ie,{children:r.jsxs(D,{className:"mb-3",children:[r.jsx($,{children:"Nombre del Parcial"}),r.jsx(L,{ref:E,maxLength:20,type:"text",onPaste:P,onCopy:P,placeholder:"Ingrese el nuevo nombre del parcial",value:g.Nombre_parcial,onChange:e=>K(e,o=>R({...g,Nombre_parcial:o}))})]})})}),r.jsxs(V,{children:[r.jsx(c,{color:"secondary",onClick:()=>_(k,M),children:"Cancelar"}),r.jsxs(c,{style:{backgroundColor:"#F9B64E",color:"white"},onClick:je,children:[r.jsx(m,{icon:te,style:{marginRight:"5px"}})," Actualizar"]})]})]}),r.jsxs(U,{visible:he,onClose:()=>S(!1),backdrop:"static",children:[r.jsx(H,{children:r.jsx(W,{children:"Confirmar Eliminación"})}),r.jsx(J,{children:r.jsxs("p",{children:["¿Estás seguro de que deseas eliminar el parcial: ",r.jsx("b",{children:A.Nombre_parcial}),"?"]})}),r.jsxs(V,{children:[r.jsx(c,{color:"secondary",onClick:()=>S(!1),children:"Cancelar"}),r.jsxs(c,{style:{backgroundColor:"#E57368",color:"white"},onClick:ye,children:[r.jsx(m,{icon:se,style:{marginRight:"5px"}})," Eliminar"]})]})]})]})};export{Ar as default};
