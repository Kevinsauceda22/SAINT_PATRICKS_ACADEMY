import{r as d,x as Pe,j as o,h as Z}from"./index-SVRFFNc9.js";import{C as u}from"./index.esm-DWwMdKxH.js";import{S as i}from"./sweetalert2.esm.all-D3pEHXw3.js";import{u as ke}from"./usePermission-BCWksQX7.js";import Te from"./AccessDenied-yaDW3Jao.js";import{l as Fe}from"./logo_saint_patrick-xw7Wl8f3.js";import{E as ve}from"./jspdf.plugin.autotable-gke1D7B3.js";import{u as k,w as Ee}from"./xlsx-lwdk4T0U.js";import{C as Ne}from"./CContainer-BdNP0s3v.js";import{C as K,a as A}from"./CRow-Bf67u6lu.js";import{a as p}from"./CButton-D9GPTbB6.js";import{c as Me}from"./cil-plus-D8mtC-W5.js";import{C as _e,a as Ae,b as De,c as Q}from"./CDropdownToggle-DlfIUTmX.js";import{c as Re}from"./cil-description-MUzg6O3n.js";import{c as ze}from"./cil-file-CeQgYs_D.js";import{c as Ie}from"./cil-spreadsheet-CJUvf_vM.js";import{C as w}from"./CInputGroup-D-McUFva.js";import{C as T}from"./CInputGroupText-Cfu0fzaY.js";import{c as Be}from"./cil-search-CDkY_4k-.js";import{C as F}from"./CFormInput-B_gylY64.js";import{c as $e}from"./cil-brush-alt-CV61lKqC.js";import{C as Le}from"./CFormSelect-CzT7g5tb.js";import{C as Oe,a as Ve,b as X,c as S,d as Ue,e as P}from"./CTable-98qqrSRH.js";import{c as ee}from"./cil-pen-53d2I-C-.js";import{C as He}from"./CPagination-UopCEeNZ.js";import{C as oe,a as te,b as re,c as ae}from"./CModalHeader-Bhtr3bZe.js";import{C as ne}from"./CModalTitle-M2mBvD_5.js";import{C as se}from"./CForm-CYRkMwLo.js";import{c as We}from"./cil-save-CHBg7z_U.js";import"./CConditionalPortal-DwBsYzTA.js";import"./CFormControlWrapper-OEJgTi6e.js";import"./CFormControlValidation-CtDkyDfm.js";import"./CFormLabel-szm2Dda9.js";import"./CBackdrop-BbuVwMMD.js";const No=()=>{const{canSelect:ie,loading:Ge,error:Je,canDelete:Ye,canInsert:le,canUpdate:ce}=ke("ListaParametro"),[h,de]=d.useState([]),[me,v]=d.useState(!1),[pe,E]=d.useState(!1),[g,D]=d.useState(""),[R,z]=d.useState(""),[N,I]=d.useState({}),[V,U]=d.useState(""),[f,M]=d.useState(1),[C,ue]=d.useState(5),[he,b]=d.useState(!1),B=d.useRef(null);d.useRef(null),d.useRef(null);const j=d.useRef(null),H=e=>new Date(e).toLocaleString("es-ES",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});d.useEffect(()=>{$();const e=localStorage.getItem("token");if(e)try{const t=Pe(e);console.log("Token decodificado:",t)}catch(t){console.error("Error al decodificar el token:",t)}},[]);const $=async()=>{try{const e=await fetch("http://localhost:4000/api/parametro/parametro");if(!e.ok)throw new Error("No se pudieron obtener los parámetros");const r=(await e.json()).map(a=>({...a,Fecha_Creacion:H(a.Fecha_Creacion),Fecha_Modificacion:H(a.Fecha_Modificacion)}));de(r)}catch(e){console.error("Error:",e)}},L=(e,t,r)=>{const a=e.target,s=a.selectionStart;let l=a.value.toUpperCase().trimStart();if(!/^[A-ZÁÉÍÓÚÑ0-9_\s]*$/.test(l)){i.fire({icon:"warning",title:"Caracteres no permitidos",text:"Solo se permiten letras, números y espacios."});return}/\s{2,}/.test(l)&&(i.fire({icon:"warning",title:"Espacios múltiples",text:"No se permite más de un espacio entre palabras."}),l=l.replace(/\s+/g," ")),a.value=l,t(l),b(!0),requestAnimationFrame(()=>{r.current&&r.current.setSelectionRange(s,s)})},O=(e,t)=>{const a=e.target.selectionStart;t.current&&t.current.setSelectionRange(a,a)},y=e=>{e.preventDefault(),i.fire({icon:"warning",title:"Acción bloqueada",text:"Copiar y pegar no está permitido."})},W=(e,t)=>{he?i.fire({title:"¿Estás seguro?",text:"Si cierras este formulario, perderás todos los datos ingresados.",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, cerrar",cancelButtonText:"Cancelar"}).then(r=>{r.isConfirmed&&(e(!1),t(),b(!1))}):(e(!1),t(),b(!1))},G=()=>{D(""),z(""),b(!1)},xe=async()=>{if(!g.trim()||!R.trim()){i.fire({icon:"error",title:"Error",text:'Los campos "Parámetro" y "Valor" no pueden estar vacíos'});return}try{if(h.some(c=>c.Parametro.trim().toLowerCase()===g.trim().toLowerCase())){i.fire({icon:"error",title:"Error",text:`El parámetro "${g}" ya existe.`});return}const t=new Date().toISOString(),r=new Date().toISOString(),a=localStorage.getItem("token"),s=Z(a);if(!s.cod_usuario||!s.nombre_usuario)throw console.error("No se pudo obtener el código o el nombre de usuario del token"),new Error("No se pudo obtener el código o el nombre de usuario del token");const l=await fetch("http://localhost:4000/api/parametro/crearparametro",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({Parametro:g,Valor:R,Fecha_Creacion:t,Fecha_Modificacion:r})}),n=await l.json();if(l.ok){const c=`El usuario: ${s.nombre_usuario} ha creado nuevo parámetro: ${g} `;(await fetch("http://localhost:4000/api/bitacora/registro",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({cod_usuario:s.cod_usuario,cod_objeto:95,accion:"INSERT",descripcion:c})})).ok?console.log("Registro en bitácora exitoso"):i.fire("Error","No se pudo registrar la acción en la bitácora","error"),$(),v(!1),D(""),z(""),b(!1),i.fire({icon:"success",title:"¡Éxito!",text:"El parámetro se ha creado correctamente.",confirmButtonText:"Aceptar"})}else i.fire({icon:"error",title:"Error de validación",text:n.Mensaje||"Hubo un problema al crear el parámetro"})}catch(e){console.error("Error al crear el parámetro:",e),i.fire({icon:"error",title:"Error en el servidor",text:"Hubo un problema en el servidor. Inténtalo más tarde."})}},ge=e=>{const t=new Date(e),r=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0"),l=String(t.getHours()).padStart(2,"0"),n=String(t.getMinutes()).padStart(2,"0"),c=String(t.getSeconds()).padStart(2,"0");return`${r}-${a}-${s} ${l}:${n}:${c}`},fe=async()=>{const{Cod_parametro:e,Parametro:t,Valor:r}=N;if(!t||!r){i.fire({icon:"error",title:"Error",text:"Todos los campos son obligatorios"});return}try{const a=localStorage.getItem("token");if(!a){i.fire("Error","No tienes permiso para realizar esta acción","error");return}const s=Z(a);if(!s.cod_usuario||!s.nombre_usuario)throw console.error("No se pudo obtener el código o el nombre de usuario del token"),new Error("No se pudo obtener el código o el nombre de usuario del token");const l=ge(new Date);if((await fetch("http://localhost:4000/api/parametro/actualizarparametro",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({Cod_parametro:e,Parametro:t,Valor:r,Fecha_Modificacion:l})})).ok){const c=`El usuario: ${s.nombre_usuario} actualizó el parámetro: ${t}`;(await fetch("http://localhost:4000/api/bitacora/registro",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({cod_usuario:s.cod_usuario,cod_objeto:95,accion:"UPDATE",descripcion:c})})).ok?console.log("Registro en bitácora exitoso"):i.fire("Error","No se pudo registrar la acción en la bitácora","error"),$(),E(!1),I({}),i.fire({icon:"success",title:"¡Éxito!",text:"Parámetro actualizado correctamente",confirmButtonText:"Aceptar"})}else i.fire({icon:"error",title:"Error",text:"Hubo un problema al actualizar el parámetro"})}catch{i.fire({icon:"error",title:"Error",text:"Intenta nuevamente más tarde."})}},Ce=e=>{I(e),E(!0)},be=e=>{let r=e.target.value.toUpperCase().trimStart();const a=/^[A-ZÑÁÉÍÓÚ0-9\s,]*$/;if(/\s{2,}/.test(r)&&(i.fire({icon:"warning",title:"Espacios múltiples",text:"No se permite más de un espacio entre palabras."}),r=r.replace(/\s+/g," ")),!a.test(r)){i.fire({icon:"warning",title:"Caracteres no permitidos",text:"Solo se permiten letras, números y espacios."});return}const s=r.split(" ");for(let l of s){const n={};for(let c of l)if(n[c]=(n[c]||0)+1,n[c]>4){i.fire({icon:"warning",title:"Repetición de letras",text:`La letra "${c}" se repite más de 4 veces en la palabra "${l}".`});return}}U(r),M(1)},_=h.filter(e=>e.Parametro.toLowerCase().includes(V.toLowerCase())),J=f*C,je=J-C,ye=_.slice(je,J),Y=e=>{e>0&&e<=Math.ceil(_.length/C)&&M(e)};if(!ie)return o.jsx(Te,{});const we=()=>{if(!h||h.length===0){i.fire({icon:"info",title:"Tabla vacía",text:"No hay datos disponibles para generar el reporte.",confirmButtonText:"Aceptar"});return}const e=new ve,t=new Image;t.src=Fe,t.onload=()=>{e.addImage(t,"PNG",10,10,30,30);let r=20;e.setFontSize(18),e.setTextColor(0,102,51),e.text("SAINT PATRICK'S ACADEMY",e.internal.pageSize.width/2,r,{align:"center"}),r+=12,e.setFontSize(16),e.text("Reporte de Parámetros",e.internal.pageSize.width/2,r,{align:"center"}),r+=10,e.setFontSize(10),e.setTextColor(100),e.text("Casa Club del periodista, Colonia del Periodista",e.internal.pageSize.width/2,r,{align:"center"}),r+=4,e.text("Teléfono: (504) 2234-8871",e.internal.pageSize.width/2,r,{align:"center"}),r+=4,e.text("Correo: info@saintpatrickacademy.edu",e.internal.pageSize.width/2,r,{align:"center"}),r+=6,e.setLineWidth(.5),e.setDrawColor(0,102,51),e.line(10,r,e.internal.pageSize.width-10,r);const a=e.internal.pageSize.height;e.autoTable({startY:r+4,head:[["#","Parámetro","Valor","Fecha Creación","Fecha Modificación"]],body:h.map((n,c)=>[c+1,`${n.Parametro||""}`.trim(),n.Valor,n.Fecha_Creacion,n.Fecha_Modificacion]),headStyles:{fillColor:[0,102,51],textColor:[255,255,255],fontSize:10},styles:{fontSize:10,cellPadding:3,halign:"center"},columnStyles:{0:{cellWidth:"auto"},1:{cellWidth:"auto"},2:{cellWidth:"auto"},3:{cellWidth:"auto"},4:{cellWidth:"auto"}},alternateRowStyles:{fillColor:[240,248,255]},didDrawPage:n=>{const c=new Date,m=`${c.toLocaleDateString()} ${c.toLocaleTimeString()}`,x=e.internal.pageSize.height;e.setFontSize(10),e.setTextColor(100),e.text(`Fecha y hora de generación: ${m}`,10,x-10)}});const s=e.internal.getNumberOfPages(),l=e.internal.pageSize.width;for(let n=1;n<=s;n++){e.setPage(n),e.setTextColor(100);const c=`Página ${n} de ${s}`;e.text(c,l-30,a-10)}window.open(e.output("bloburl"),"_blank")},t.onerror=()=>{console.warn("No se pudo cargar el logo. El PDF se generará sin el logo."),window.open(e.output("bloburl"),"_blank")}},Se=()=>{if(!h||h.length===0){i.fire({icon:"info",title:"Tabla vacía",text:"No hay datos disponibles para generar el reporte excel.",confirmButtonText:"Aceptar"});return}const e=[["Saint Patrick Academy"],["Reporte de Parámetros"],[],["#","Parámetro","Valor","Fecha Creacion","Fecha Modificación"]],t=h.map((m,x)=>[x+1,m.Parametro,m.Valor,m.Fecha_Creacion,m.Fecha_Modificacion]),r=[...e,...t],a=k.aoa_to_sheet(r),s=k.decode_range(a["!ref"]);for(let m=0;m<=3;m++)for(let x=s.s.c;x<=s.e.c;x++){const q=k.encode_cell({r:m,c:x});a[q]&&(a[q].s={font:{bold:!0,sz:14,color:{rgb:"FFFFFF"}},fill:{fgColor:{rgb:"15401D"}},alignment:{horizontal:"center"}})}const l=[{wpx:100},{wpx:100},{wpx:100},{wpx:100},{wpx:100}];a["!cols"]=l;const n=k.book_new();k.book_append_sheet(n,a,"Reporte de Parámetros"),Ee(n,"Reporte_Parámetros.xlsx")};return o.jsxs(Ne,{children:[o.jsxs(K,{className:"align-items-center mb-5",children:[o.jsx(A,{xs:"12",md:"9",children:o.jsx("h1",{className:"mb-0",children:"Parámetros"})}),o.jsxs(A,{xs:"12",md:"3",className:"text-end d-flex flex-column flex-md-row justify-content-md-end align-items-md-center mt-3 mt-md-0",children:[le&&o.jsxs(p,{className:"mb-3 mb-md-0 me-md-3 gap-1 rounded shadow",style:{backgroundColor:"#4B6251",color:"white",transition:"all 0.3s ease",height:"40px",width:"auto",minWidth:"100px",padding:"0 16px",fontSize:"16px",display:"flex",alignItems:"center",justifyContent:"center"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="#3C4B43",e.currentTarget.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="#4B6251",e.currentTarget.style.boxShadow="none"},onClick:()=>{v(!0),b(!1)},children:[o.jsx(u,{icon:Me})," Nuevo"]}),o.jsxs(_e,{className:"btn-sm d-flex align-items-center gap-1 rounded shadow",children:[o.jsxs(Ae,{style:{backgroundColor:"#6C8E58",color:"white",cursor:"pointer",transition:"all 0.3s ease"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="#5A784C",e.currentTarget.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="#6C8E58",e.currentTarget.style.boxShadow="none"},children:[o.jsx(u,{icon:Re})," Reporte"]}),o.jsxs(De,{style:{position:"absolute",zIndex:1050,backgroundColor:"#fff",boxShadow:"0px 2px 8px rgba(0, 0, 0, 0.2)",borderRadius:"4px",overflow:"hidden"},children:[o.jsxs(Q,{onClick:we,style:{cursor:"pointer",outline:"none",backgroundColor:"transparent",padding:"0.5rem 1rem",fontSize:"0.85rem",color:"#333",borderBottom:"1px solid #eaeaea",transition:"background-color 0.1s"},onMouseOver:e=>e.target.style.backgroundColor="#f5f5f5",onMouseOut:e=>e.target.style.backgroundColor="transparent",children:[o.jsx(u,{icon:ze,size:"sm"})," Abrir en PDF"]}),o.jsxs(Q,{onClick:Se,style:{cursor:"pointer",outline:"none",backgroundColor:"transparent",padding:"0.5rem 1rem",fontSize:"0.85rem",color:"#333",transition:"background-color 0.3s"},onMouseOver:e=>e.target.style.backgroundColor="#f5f5f5",onMouseOut:e=>e.target.style.backgroundColor="transparent",children:[o.jsx(u,{icon:Ie,size:"sm"})," Descargar Excel"]})]})]})]})]}),o.jsxs(K,{className:"align-items-center mt-4 mb-2",children:[o.jsx(A,{xs:"12",md:"8",className:"d-flex flex-wrap align-items-center",children:o.jsxs(w,{className:"me-3",style:{width:"400px"},children:[o.jsx(T,{children:o.jsx(u,{icon:Be})}),o.jsx(F,{placeholder:"Buscar parametro...",onChange:be,value:V}),o.jsxs(p,{style:{border:"1px solid #ccc",transition:"all 0.1s ease-in-out",backgroundColor:"#F3F4F7",color:"#343a40"},onClick:()=>{U(""),M(1)},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="#E0E0E0",e.currentTarget.style.color="black"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="#F3F4F7",e.currentTarget.style.color="#343a40"},children:[o.jsx(u,{icon:$e})," Limpiar"]})]})}),o.jsx(A,{xs:"12",md:"4",className:"text-md-end mt-2 mt-md-0",children:o.jsx(w,{className:"mt-2 mt-md-0",style:{width:"auto",display:"inline-block"},children:o.jsxs("div",{className:"d-inline-flex align-items-center",children:[o.jsx("span",{children:"Mostrar "}),o.jsxs(Le,{style:{width:"80px",display:"inline-block",textAlign:"center"},onChange:e=>{const t=Number(e.target.value);ue(t),M(1)},value:C,children:[o.jsx("option",{value:"5",children:"5"}),o.jsx("option",{value:"10",children:"10"}),o.jsx("option",{value:"20",children:"20"})]}),o.jsx("span",{children:" registros"})]})})})]}),o.jsx("div",{className:"table-container",style:{maxHeight:"400px",overflowY:"scroll",marginBottom:"20px"},children:o.jsxs(Oe,{striped:!0,bordered:!0,hover:!0,children:[o.jsx(Ve,{style:{position:"sticky",top:0,zIndex:1,backgroundColor:"#fff"},children:o.jsxs(X,{children:[o.jsx(S,{style:{width:"50px"},children:"#"}),o.jsx(S,{style:{width:"300px"},children:"PARÁMETRO"}),o.jsx(S,{style:{width:"300px"},children:"VALOR"}),o.jsx(S,{style:{width:"300px"},children:"FECHA_CREACIÓN"}),o.jsx(S,{style:{width:"300px"},children:"FECHA_MODIFICACIÓN"}),o.jsx(S,{style:{width:"150px"},children:"ACCIONES"})]})}),o.jsx(Ue,{children:ye.map((e,t)=>o.jsxs(X,{children:[o.jsx(P,{children:t+1}),o.jsx(P,{children:e.Parametro}),o.jsx(P,{children:e.Valor}),o.jsx(P,{children:e.Fecha_Creacion}),o.jsx(P,{children:e.Fecha_Modificacion}),o.jsx(P,{children:ce&&o.jsx(p,{style:{backgroundColor:"#F9B64E",marginRight:"10px"},onClick:()=>Ce(e),children:o.jsx(u,{icon:ee})})})]},e.Cod_parametro))})]})}),o.jsxs("div",{className:"pagination-container",style:{display:"flex",justifyContent:"center",alignItems:"center"},children:[o.jsxs(He,{"aria-label":"Page navigation",children:[o.jsx(p,{style:{backgroundColor:"#6f8173",color:"#D9EAD3"},disabled:f===1,onClick:()=>Y(f-1),children:"Anterior"}),o.jsx(p,{style:{marginLeft:"10px",backgroundColor:"#6f8173",color:"#D9EAD3"},disabled:f===Math.ceil(_.length/C),onClick:()=>Y(f+1),children:"Siguiente"})]}),o.jsxs("span",{style:{marginLeft:"10px"},children:["Página ",f," de ",Math.ceil(_.length/C)]})]}),o.jsxs(oe,{visible:me,backdrop:"static",children:[o.jsxs(te,{closeButton:!1,children:[o.jsx(ne,{children:"Nuevo Parámetro"}),o.jsx(p,{className:"btn-close","aria-label":"Close",onClick:()=>W(v,G)})]}),o.jsx(re,{children:o.jsxs(se,{children:[o.jsxs(w,{className:"mb-3",children:[o.jsx(T,{children:"Parámetro"}),o.jsx(F,{ref:B,type:"text",placeholder:"Ingrese el parámetro",value:g,onChange:e=>L(e,D,B),onPaste:y,onCopy:y,onFocus:e=>O(e,B)})]}),o.jsxs(w,{className:"mb-3",children:[o.jsx(T,{children:"Valor"}),o.jsx(F,{ref:j,type:"text",placeholder:"Ingrese el valor",value:R,onChange:e=>L(e,z,j),onPaste:y,onCopy:y,onFocus:e=>O(e,j)})]})]})}),o.jsxs(ae,{children:[o.jsx(p,{color:"secondary",onClick:()=>W(v,G),children:"Cancelar"}),o.jsxs(p,{style:{backgroundColor:"#4B6251",color:"white"},onClick:xe,children:[o.jsx(u,{icon:We,style:{marginRight:"5px"}})," Guardar"]})]})]}),o.jsxs(oe,{visible:pe,onClose:()=>E(!1),backdrop:"static",children:[o.jsx(te,{closeButton:!0,children:o.jsx(ne,{children:"Actualizar Parámetro"})}),o.jsx(re,{children:o.jsxs(se,{children:[o.jsxs(w,{className:"mb-3",children:[o.jsx(T,{children:"Parámetro"}),o.jsx(F,{type:"text",name:"parametro",value:N.Parametro||"",readOnly:!0,disabled:!0})]}),o.jsxs(w,{className:"mb-3",children:[o.jsx(T,{children:"Valor"}),o.jsx(F,{ref:j,type:"text",placeholder:"Valor",value:N.Valor||"",onChange:e=>L(e,t=>I({...N,Valor:t}),j),onPaste:y,onCopy:y,onFocus:e=>O(e,j)})]})]})}),o.jsxs(ae,{children:[o.jsx(p,{color:"secondary",onClick:()=>E(!1),children:"Cancelar"}),o.jsxs(p,{style:{backgroundColor:"#F9B64E",color:"white"},onClick:fe,children:[o.jsx(u,{icon:ee,style:{marginRight:"5px"}}),"Actualizar"]})]})]})]})};export{No as default};
