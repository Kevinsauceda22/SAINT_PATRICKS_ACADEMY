import{r as n,u as Ne,o as Se,j as e}from"./index-SVRFFNc9.js";import{C as p}from"./index.esm-DWwMdKxH.js";import{S as i}from"./sweetalert2.esm.all-D3pEHXw3.js";import{E as Te}from"./jspdf.plugin.autotable-gke1D7B3.js";import{u as L,a as ke}from"./xlsx-lwdk4T0U.js";import{F as we}from"./FileSaver.min-DN8zk8MP.js";import{u as Ue}from"./usePermission-BCWksQX7.js";import De from"./AccessDenied-yaDW3Jao.js";import{C as Ie}from"./CContainer-BdNP0s3v.js";import{C as K,a as T}from"./CRow-Bf67u6lu.js";import{a as l}from"./CButton-D9GPTbB6.js";import{c as Ae}from"./cil-arrow-left-D66Kb3Zq.js";import{c as He}from"./cil-plus-D8mtC-W5.js";import{C as Le,a as Be,b as Me,c as Q}from"./CDropdownToggle-DlfIUTmX.js";import{c as Fe}from"./cil-description-MUzg6O3n.js";import{C as b}from"./CInputGroup-D-McUFva.js";import{C as k}from"./CInputGroupText-Cfu0fzaY.js";import{c as $e}from"./cil-search-CDkY_4k-.js";import{C as w}from"./CFormInput-B_gylY64.js";import{c as Re}from"./cil-brush-alt-CV61lKqC.js";import{C as ze}from"./CFormSelect-CzT7g5tb.js";import{C as Ve,a as Oe,b as X,c as g,d as qe,e as f}from"./CTable-98qqrSRH.js";import{c as ee}from"./cil-pen-53d2I-C-.js";import{c as oe}from"./cil-trash-CBbKHhHb.js";import{C as We}from"./CPagination-UopCEeNZ.js";import{C as re,a as se,b as te,c as ae}from"./CModalHeader-Bhtr3bZe.js";import{C as ne}from"./CModalTitle-M2mBvD_5.js";import{C as Ge}from"./CForm-CYRkMwLo.js";import{c as Je}from"./cil-save-CHBg7z_U.js";import"./CConditionalPortal-DwBsYzTA.js";import"./CFormControlWrapper-OEJgTi6e.js";import"./CFormControlValidation-CtDkyDfm.js";import"./CFormLabel-szm2Dda9.js";import"./CBackdrop-BbuVwMMD.js";const Ho=()=>{var W,G,J,Y,Z;const{canSelect:ie,canDelete:Ye,canInsert:Ze,canUpdate:Ke}=Ue("ListaHistoricoProc"),[v,B]=n.useState([]),[U,Qe]=n.useState({cod_persona:"",instituto:"",lugar_procedencia:"",anio_ingreso:""}),[ce,D]=n.useState(!1),[le,I]=n.useState(!1),[de,A]=n.useState(!1),[d,y]=n.useState({cod_persona:"",instituto:"",lugar_procedencia:"",anio_ingreso:""}),[t,C]=n.useState({}),[M,F]=n.useState({}),[$,R]=n.useState(""),[u,E]=n.useState(1),[x,pe]=n.useState(5),[Xe,me]=n.useState(!1),ue=Ne(),z=Se(),{personaSeleccionada:r}=ue.state||{};if(!r)return console.warn("No se ha proporcionado una persona seleccionada. Redirigiendo..."),z("/"),null;v.filter(o=>o.cod_persona===r.cod_persona);const xe=()=>{z("/ListaPersonas")};n.useEffect(()=>{r&&(async()=>{try{const c=await(await fetch(`http://localhost:4000/api/historial_proc/historico_persona/${r.cod_persona}`)).json();B(c)}catch(s){console.error("Error al obtener el historial de la persona:",s)}})()},[r]),n.useEffect(()=>{console.log(r)},[r]),n.useEffect(()=>{P()},[]);const P=async()=>{try{const c=(await(await fetch("http://localhost:4000/api/historial_proc/ver_historico_procedencia")).json()).map((a,_)=>({...a,originalIndex:_+1}));B(c)}catch(o){console.error("Error al obtener el histórico de procedencia:",o)}},he=()=>{const o=v.map((h,Pe)=>({"#":Pe+1,Nombre_procedencia:h.Nombre_procedencia.toUpperCase(),Lugar_procedencia:h.Lugar_procedencia.toUpperCase(),Instituto:h.Instituto.toUpperCase()})),s=L.json_to_sheet(o),c=L.book_new();L.book_append_sheet(c,s,"Historial Procedencia");const a=ke(c,{bookType:"xlsx",type:"array"}),_=new Blob([a],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});we.saveAs(_,"reporte_historial_procedencia.xlsx")},ge=()=>{const o=new Te;o.text("Reporte del historial de procedencia",20,10),o.autoTable({head:[["#","Nombre de procedencia","Lugar de procedencia","Instituto"]],body:v.map((s,c)=>[c+1,s.Nombre_procedencia.toUpperCase(),s.Lugar_procedencia.toUpperCase(),s.Instituto.toUpperCase()])}),o.save("reporte_historial_procendencia.pdf")},N=(o,s)=>{const{name:c,value:a}=o.target;fe(a)&&s(h=>({...h,[c]:a}))},fe=o=>/^[a-zA-Z\s]*$/.test(o)?/(.)\1{3,}/.test(o)?(i.fire({icon:"error",title:"Error",text:"No se permiten 4 letras consecutivas."}),!1):/\d/.test(o)?(i.fire({icon:"error",title:"Error",text:"No se permiten números."}),!1):/( {3,})/.test(o)?(i.fire({icon:"error",title:"Error",text:"No se permiten más de 3 espacios consecutivos."}),!1):/( {2,})/.test(o)?(i.fire({icon:"error",title:"Error",text:"No se permiten más de 2 espacios consecutivos."}),!1):!0:(i.fire({icon:"error",title:"Error",text:"Solo se permiten letras y espacios."}),!1),S=o=>{o.preventDefault(),i.fire({icon:"warning",title:"Acción bloqueada",text:"Copiar y pegar no está permitido."})},m=()=>{D(!1),V(),I(!1),A(!1)},V=()=>{y({cod_persona:"",instituto:"",lugar_procedencia:"",anio_ingreso:""})},Ce=()=>{C({cod_persona:"",instituto:"",lugar_procedencia:"",anio_ingreso:""})},je=async()=>{const s=[{campo:"instituto",valor:t.cod_procedencia?t.instituto:d.instituto},{campo:"lugar_procedencia",valor:t.cod_procedencia?t.lugar_procedencia:d.lugar_procedencia},{campo:"anio_ingreso",valor:t.cod_procedencia?t.anio_ingreso:d.anio_ingreso},{campo:"cod_persona",valor:r?r.cod_persona:null}].find(a=>!a.valor||a.valor.toString().trim()==="");if(s){console.error(`El campo "${s.campo}" está vacío o no es válido.`),i.fire({icon:"error",title:"Datos incompletos",text:`El campo "${s.campo}" es obligatorio.`,confirmButtonText:"Entendido"});return}const c={cod_persona:r.cod_persona,instituto:t.cod_procedencia?t.instituto:d.instituto,lugar_procedencia:t.cod_procedencia?t.lugar_procedencia:d.lugar_procedencia,anio_ingreso:t.cod_procedencia?t.anio_ingreso:d.anio_ingreso};try{if(t.cod_procedencia){const a=await fetch(`http://localhost:4000/api/historial_proc/actualizar_historico/${t.cod_procedencia}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});a.ok?(i.fire({icon:"success",title:"Éxito",text:"Procedencia actualizada correctamente",confirmButtonText:"Aceptar"}),m(I,Ce),P(r.cod_persona)):(console.error("Error en la respuesta de la API:",a),i.fire({icon:"error",title:"Error",text:"Error al actualizar la procedencia",confirmButtonText:"Aceptar"}))}else{const a=await fetch("http://localhost:4000/api/historial_proc/crear_historico",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});a.ok?(i.fire({icon:"success",title:"Éxito",text:"Procedencia agregada correctamente",confirmButtonText:"Aceptar"}),m(D,V),P(r.cod_persona)):(console.error("Error en la respuesta de la API:",a),i.fire({icon:"error",title:"Error",text:"Error al agregar la procedencia",confirmButtonText:"Aceptar"}))}}catch(a){console.error("Error en la petición:",a),i.fire({icon:"error",title:"Error de conexión",text:"Hubo un error al conectar con la API",confirmButtonText:"Aceptar"})}},_e=async()=>{try{const o=await fetch(`http://localhost:4000/api/historial_proc/eliminar_historico/${encodeURIComponent(M.cod_procedencia)}`,{method:"DELETE",headers:{"Content-Type":"application/json"}}),s=await o.json();o.ok?(P(),A(!1),F({}),i.fire({icon:"success",title:"Eliminación exitosa",text:"La procedencia se ha sido eliminada correctamente."})):(i.fire({icon:"error",title:"Error",text:s.mensaje||"Hubo un error al eliminar la procedencia."}),console.error("Error al eliminar la procedencia:",s))}catch(o){console.error("Error al eliminar la procedencia:",o),i.fire({icon:"error",title:"Error en el servidor",text:"Hubo un error en el servidor. Inténtalo más tarde."})}},be=o=>{C(o),I(!0),me(!1)},ve=o=>{F(o),A(!0)},ye=o=>{R(o.target.value),E(1)},j=v.filter(o=>{const s=$.toUpperCase();return String(o.cod_procedencia).toUpperCase().includes(s)||String(o.cod_persona).toUpperCase().includes(s)||o.instituto.toUpperCase().includes(s)||o.lugar_procedencia.toUpperCase().includes(s)||String(o.anio_ingreso).toUpperCase().includes(s)}),O=u*x,q=O-x,Ee=j.slice(q,O),H=o=>{o>0&&o<=Math.ceil(j.length/x)&&E(o)};return ie?e.jsxs(Ie,{children:[e.jsxs(K,{className:"align-items-center mb-5",children:[e.jsxs(T,{xs:"8",md:"9",children:[e.jsx("h2",{className:"mb-0",children:"Historial Procedencia"}),r?e.jsxs("div",{style:{marginTop:"10px",fontSize:"16px",color:"#555"},children:[e.jsx("strong",{children:"Procedencia del estudiante:"})," ",r?`${r.Nombre.toUpperCase()} ${((W=r.Segundo_nombre)==null?void 0:W.toUpperCase())||""} ${r.Primer_apellido.toUpperCase()} ${((G=r.Segundo_apellido)==null?void 0:G.toUpperCase())||""}`:"Información no disponible"]}):e.jsxs("div",{style:{marginTop:"10px",fontSize:"16px",color:"#555"},children:[e.jsx("strong",{children:"Persona Seleccionada:"})," Información no disponible"]})]}),e.jsxs(T,{xs:"4",md:"3",className:"text-end d-flex flex-column flex-md-row justify-content-md-end align-items-md-center",children:[e.jsxs(l,{color:"secondary",onClick:xe,style:{minWidth:"120px"},className:"mb-3 mb-md-0 me-md-3",children:[e.jsx(p,{icon:Ae})," Personas"]}),e.jsxs(l,{style:{backgroundColor:"#4B6251",color:"white",minWidth:"120px"},className:"mb-3 mb-md-0 me-md-3",onClick:()=>D(!0),children:[e.jsx(p,{icon:He})," Nuevo"]}),e.jsxs(Le,{children:[e.jsxs(Be,{style:{backgroundColor:"#6C8E58",color:"white",minWidth:"120px"},className:"mb-3 mb-md-0 me-md-3",children:[e.jsx(p,{icon:Fe})," Reporte"]}),e.jsxs(Me,{children:[e.jsx(Q,{onClick:he,children:"Descargar en Excel"}),e.jsx(Q,{onClick:ge,children:"Descargar en PDF"})]})]})]})]}),e.jsxs(K,{className:"align-items-center mt-4 mb-2",children:[e.jsx(T,{xs:"12",md:"8",className:"d-flex flex-wrap align-items-center",children:e.jsxs(b,{className:"me-3",style:{width:"400px"},children:[e.jsx(k,{children:e.jsx(p,{icon:$e})}),e.jsx(w,{placeholder:"Buscar procedencia",onChange:ye,value:$}),e.jsxs(l,{style:{border:"1px solid #ccc",transition:"all 0.1s ease-in-out",backgroundColor:"#F3F4F7",color:"#343a40"},onClick:()=>{R(""),E(1)},onMouseEnter:o=>{o.currentTarget.style.backgroundColor="#E0E0E0",o.currentTarget.style.color="black"},onMouseLeave:o=>{o.currentTarget.style.backgroundColor="#F3F4F7",o.currentTarget.style.color="#343a40"},children:[e.jsx(p,{icon:Re})," Limpiar"]})]})}),e.jsx(T,{xs:"12",md:"4",className:"text-md-end mt-2 mt-md-0",children:e.jsx(b,{className:"mt-2 mt-md-0",style:{width:"auto",display:"inline-block"},children:e.jsxs("div",{className:"d-inline-flex align-items-center",children:[e.jsx("span",{children:"Mostrar "}),e.jsxs(ze,{style:{width:"80px",display:"inline-block",textAlign:"center"},onChange:o=>{const s=Number(o.target.value);pe(s),E(1)},value:x,children:[e.jsx("option",{value:"5",children:"5"}),e.jsx("option",{value:"10",children:"10"}),e.jsx("option",{value:"20",children:"20"})]}),e.jsx("span",{children:" registros"})]})})})]}),e.jsx("div",{className:"table-container",style:{maxHeight:"400px",overflowY:"scroll",marginBottom:"20px"},children:e.jsxs(Ve,{striped:!0,bordered:!0,hover:!0,children:[e.jsx(Oe,{children:e.jsxs(X,{children:[e.jsx(g,{children:"#"}),e.jsx(g,{children:"Nombre"}),e.jsx(g,{children:"Instituto"}),e.jsx(g,{children:"Lugar de Procedencia"}),e.jsx(g,{children:"Año de Ingreso"}),e.jsx(g,{children:"Acciones"})]})}),e.jsx(qe,{children:Ee.filter(o=>(console.log("filtrando por cod_persona:",r==null?void 0:r.cod_persona),o.cod_persona===(r==null?void 0:r.cod_persona))).map((o,s)=>e.jsxs(X,{children:[e.jsx(f,{children:s+1+q}),e.jsx(f,{children:r?`${r.Nombre.toUpperCase()} ${r.Segundo_nombre.toUpperCase()} ${r.Primer_apellido.toUpperCase()} ${r.Segundo_apellido.toUpperCase()}`:"Información no disponible"}),e.jsx(f,{children:o.instituto.toUpperCase()}),e.jsx(f,{children:o.lugar_procedencia.toUpperCase()}),e.jsx(f,{children:o.anio_ingreso}),e.jsxs(f,{children:[e.jsx(l,{color:"warning",onClick:()=>be(o),children:e.jsx(p,{icon:ee})}),e.jsx(l,{color:"danger",onClick:()=>ve(o),className:"ms-2",children:e.jsx(p,{icon:oe})})]})]},o.cod_procedencia))})]})}),e.jsx(We,{align:"center","aria-label":"Page navigation example",activePage:u,pages:Math.ceil(j.length/x),onActivePageChange:H}),e.jsxs("div",{className:"d-flex justify-content-center align-items-center mt-3",children:[e.jsx(l,{style:{backgroundColor:"#6f8173",color:"#D9EAD3"},disabled:u===1,onClick:()=>H(u-1),children:"Anterior"}),e.jsx(l,{style:{marginLeft:"10px",backgroundColor:"#6f8173",color:"#D9EAD3"},disabled:u===Math.ceil(j.length/x),onClick:()=>H(u+1),children:"Siguiente"}),e.jsxs("div",{style:{marginLeft:"10px"},children:["Página ",u," de ",Math.ceil(j.length/x)]})]}),e.jsxs(re,{visible:ce||le,onClose:()=>{t.cod_procedencia,m()},backdrop:"static",children:[e.jsx(se,{closeButton:!0,children:e.jsx(ne,{children:t.cod_procedencia?"Actualizar Procedencia":"Ingresar Procedencia"})}),e.jsxs(te,{children:[e.jsxs("div",{style:{marginBottom:"10px",border:"1px solid #dcdcdc",padding:"10px",backgroundColor:"#f9f9f9"},children:[e.jsx("strong",{children:"PERSONA:"})," ",r?`${r.Nombre.toUpperCase()} ${((J=r.Segundo_nombre)==null?void 0:J.toUpperCase())||""} ${r.Primer_apellido.toUpperCase()} ${((Y=r.Segundo_apellido)==null?void 0:Y.toUpperCase())||""}`:"Información no disponible"]}),e.jsxs(Ge,{children:[e.jsx("div",{className:"mb-3",children:e.jsxs(b,{className:"mb-3",children:[e.jsx(k,{children:"Instituto"}),e.jsx(w,{name:"instituto",value:t.instituto||d.instituto||"",maxLength:80,onPaste:S,onCopy:S,style:{textTransform:"uppercase"},onChange:o=>t.cod_procedencia?N(o,C):N(o,y)})]})}),e.jsx("div",{className:"mb-3",children:e.jsxs(b,{className:"mb-3",children:[e.jsx(k,{children:"Lugar de Procedencia"}),e.jsx(w,{name:"lugar_procedencia",value:t.lugar_procedencia||d.lugar_procedencia||"",maxLength:80,onPaste:S,onCopy:S,style:{textTransform:"uppercase"},onChange:o=>t.cod_procedencia?N(o,C):N(o,y)})]})}),e.jsx("div",{className:"mb-3",children:e.jsxs(b,{className:"mb-3",children:[e.jsx(k,{children:"Año de Ingreso"}),e.jsx(w,{name:"anio_ingreso",type:"number",min:"1900",max:new Date().getFullYear(),value:t.anio_ingreso||d.anio_ingreso||"",onChange:o=>t.cod_procedencia?C(s=>({...s,anio_ingreso:o.target.value})):y(s=>({...s,anio_ingreso:o.target.value}))})]})})]})]}),e.jsxs(ae,{children:[e.jsx(l,{style:{backgroundColor:"#6c757d",color:"white",borderColor:"#6c757d"},onClick:()=>{t.cod_procedencia,m()},children:"Cancelar"}),e.jsxs(l,{style:{backgroundColor:"#4B6251",color:"white",borderColor:"#4B6251"},onClick:je,disabled:U.instituto||U.lugar_procedencia||U.anio_ingreso,children:[e.jsx(p,{icon:t.cod_procedencia?ee:Je})," ",t.cod_procedencia?"Actualizar":"Guardar"]})]})]}),e.jsxs(re,{visible:de,backdrop:"static",children:[e.jsxs(se,{closeButton:!1,children:[e.jsx(ne,{children:"Eliminar Procedencia"}),e.jsx(l,{className:"btn-close","aria-label":"Close",onClick:()=>m()})]}),e.jsxs(te,{children:['¿Estás seguro de que deseas eliminar la procedencia "',(Z=M.Nombre_procedencia)==null?void 0:Z.toUpperCase(),'"?']}),e.jsxs(ae,{children:[e.jsx(l,{color:"secondary",onClick:m,children:"Cancelar"}),e.jsxs(l,{style:{backgroundColor:"#E57368",color:"white"},onClick:_e,children:[e.jsx(p,{icon:oe,style:{marginRight:"5px"}}),"Eliminar"]})]})]})]}):e.jsx(De,{})};export{Ho as default};
