import{r as a,j as o}from"./index-SVRFFNc9.js";import{C as x}from"./index.esm-DWwMdKxH.js";import{S as m}from"./sweetalert2.esm.all-D3pEHXw3.js";import"./jspdf.plugin.autotable-gke1D7B3.js";import"./FileSaver.min-DN8zk8MP.js";import{C as je}from"./CContainer-BdNP0s3v.js";import{a as l}from"./CButton-D9GPTbB6.js";import{c as be}from"./cil-plus-D8mtC-W5.js";import{c as Ae}from"./cil-description-MUzg6O3n.js";import{C as Se}from"./CInputGroupText-Cfu0fzaY.js";import{c as _e}from"./cil-search-CDkY_4k-.js";import{C as H}from"./CFormInput-B_gylY64.js";import{c as Ee}from"./cil-brush-alt-CV61lKqC.js";import{C as f}from"./CFormSelect-CzT7g5tb.js";import{C as ye,a as ve,b as F,c,d as Pe,e as d}from"./CTable-98qqrSRH.js";import{c as Oe}from"./cil-pen-53d2I-C-.js";import{c as we}from"./cil-trash-CBbKHhHb.js";import{C as B,a as L,b as $,c as U}from"./CModalHeader-Bhtr3bZe.js";import{C as z}from"./CModalTitle-M2mBvD_5.js";import{C as Ne}from"./CForm-CYRkMwLo.js";import"./CFormControlWrapper-OEJgTi6e.js";import"./CFormControlValidation-CtDkyDfm.js";import"./CFormLabel-szm2Dda9.js";import"./CBackdrop-BbuVwMMD.js";import"./CConditionalPortal-DwBsYzTA.js";const no=()=>{const[V,De]=a.useState([]),[J,C]=a.useState(!1),[Q,E]=a.useState(!1),[Y,p]=a.useState(""),[y,P]=a.useState(null),[u,O]=a.useState(""),[n,g]=a.useState(1),[j,W]=a.useState(5),[X,Z]=a.useState([]),[w,q]=a.useState([]),[K,ee]=a.useState([]),[i,b]=a.useState({Estudiante:"Seleccione una opción",Grado:"Seleccione una opción",Año_Academico:"Seleccione una opción",Promedio_Anual:0,Instituto:""});a.useEffect(()=>{A(),re(),te(),oe()},[]);const oe=async()=>{try{const r=await(await fetch("http://localhost:4000/api/persona/verPersonas")).json();console.log(r),ee(r)}catch(e){console.error("Error al obtener los estudiantes: ",e)}},re=async()=>{try{const r=await(await fetch("http://localhost:4000/api/grados/vergrados")).json();console.log(r),Z(r)}catch(e){console.error("Error al obtener los grados:",e)}},te=async()=>{try{const r=await(await fetch("http://localhost:4000/api/instituto/instituto")).json();console.log(r),q(r)}catch(e){console.error("Error al obtener los institutos: ",e)}},A=async()=>{try{const e=await fetch("http://localhost:4000/api/historialAcademico/gradosMatricula");if(!e.ok)throw new Error("Error en la solicitud al servidor");const r=await e.json(),t=["Primero","Segundo","Tercero","Cuarto","Quinto","Sexto","Séptimo","Octavo","Noveno","Décimo","Undécimo","Duodécimo"],s=r.data.sort((h,ge)=>t.indexOf(h.Nombre_grado)-t.indexOf(ge.Nombre_grado));console.log(s),setGradosMatricula(s)}catch(e){console.error("Error al obtener los grados:",e)}},se=()=>{O("")},[N,Re]=a.useState(5),[ae,ke]=a.useState(""),[ie,Te]=a.useState(1),S=()=>{b({Cod_persona:"",Cod_grado:"",Año_Academico:"",Promedio_Anual:"",Cod_Instituto:"",Observacion:""}),p("")},ne=GradosMatricula.filter(e=>e.Nombre_grado.toLowerCase().includes(ae.toLowerCase())),D=ie*N,le=D-N,ce=ne.slice(le,D);a.useState(5);const[de,Ie]=a.useState("");a.useState(1),Estudiantes.filter(e=>Object.values({Nombre_persona:e.Nombre_persona,SNombre_persona:e.SNombre_persona,PApellido_persona:e.PApellido_persona,SApellido_persona:e.SApellido_persona}).some(r=>r==null?void 0:r.toLowerCase().includes(de.toLowerCase())));const R=V.filter(e=>{const r=e.Cod_estado===1?"APROBADO":e.Cod_estado===2?"REPROBADO":"otro estado";return e.Cod_historial_academico.toString().includes(u)||e.Estudiante.toLowerCase().trim().includes(u.toLowerCase().trim())||e.Grado.toLowerCase().includes(u.toLowerCase())||e.Año_Academico.toString().includes(u)||e.Promedio_Anual.toString().includes(u)||e.Instituto.toLowerCase().includes(u.toLowerCase())||r.includes(u.toLowerCase())}),k=n*j,T=k-j,ue=R.slice(T,k),v=Math.ceil(R.length/j),_=(e,r)=>{let t=e.target.value;if(r==="Promedio_Anual"){if(t&&!/^\d*\.?\d*$/.test(t)){m.fire({icon:"error",title:"Formato inválido",text:"Por favor ingrese un valor numérico válido, incluyendo un punto decimal.",confirmButtonColor:"#6f8173"});return}if(t!==""&&(parseFloat(t)<0||parseFloat(t)>100)){m.fire({icon:"error",title:"Rango inválido",text:"El Promedio Anual debe estar entre 0 y 100.",confirmButtonColor:"#6f8173"});return}}p(""),b({...i,[r]:t})},I=()=>{const{Estudiante:e,Grado:r,Año_Academico:t,Promedio_Anual:s,Instituto:h}=i;return!e||!r||!t||!s||!h?(p("Por favor, complete todos los campos."),!1):(p(""),!0)},me=async()=>{if(!I())return;const r=parseFloat(i.Promedio_Anual)>69.99?1:2,t={...i,Cod_estado:r};try{const s=await fetch("http://localhost:4000/api/historialAcademico/crearhistorial",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(s.ok)await A(),g(1),S(),C(!1);else{const h=await s.json();p("Error al crear el historial: "+h.message)}}catch(s){p("Error al crear el historial: "+s.message)}},he=e=>{switch(e){case 1:return"APROBADO";case 2:return"REPROBADO"}},pe=e=>{P(e),b({...e}),C(!0)},xe=async()=>{if(Y||!I())return;const r=parseFloat(i.Promedio_Anual)>=70?1:2,t={...i,Cod_estado:r};try{const s=await fetch("http://localhost:4000/api/historialAcademico/actualizarhistorial",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(s.ok)A(),C(!1),P(null),S();else{const h=await s.json();console.error("Error al actualizar el historial:",h)}}catch(s){console.error("Error al actualizar el historial:",s)}},G=()=>{S(),C(!1)},Ce=async e=>{if((await m.fire({title:"¿Estás seguro?",text:"Este historial se eliminará permanentemente.",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, eliminar",cancelButtonText:"No, cancelar",confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",allowOutsideClick:!1})).isConfirmed)try{const t=await fetch("http://localhost:4000/api/historialAcademico/eliminarhistorial",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({Cod_historial_academico:e})});if(t.ok)m.fire("Eliminado","El historial ha sido eliminado correctamente.","success"),A();else{const s=await t.json();console.error("Error al eliminar el historial:",s),m.fire("Error","Hubo un error al eliminar el historial.","error")}}catch(t){console.error("Error al eliminar el historial:",t),m.fire("Error","Hubo un error al eliminar el historial.","error")}},fe=(e=1901)=>{const r=["Seleccione una opción"],t=new Date().getFullYear();for(let s=t;s>=e;s--)r.push(s.toString());return r},M=["PRIMER GRADO","SEGUNDO GRADO","TERCER GRADO","CUARTO GRADO","QUINTO GRADO","SEXTO GRADO","SÉPTIMO GRADO","OCTAVO GRADO","NOVENO GRADO","DÉCIMO","UNDÉCIMO","DUODÉCIMO"];return[...ce].sort((e,r)=>M.indexOf(e.Nombre_grado)-M.indexOf(r.Nombre_grado)),o.jsxs(je,{children:[o.jsx("h1",{children:"Mantenimiento Historiales"}),o.jsxs("div",{style:{display:"flex",justifyContent:"flex-end"},children:[o.jsxs(l,{style:{backgroundColor:"#4B6251",color:"white"},className:"mb-3 mb-md-0 me-md-3",onClick:()=>{S(),C(!0)},children:[o.jsx(x,{icon:be})," Nuevo"]}),o.jsxs(l,{style:{backgroundColor:"#6C8E58",color:"white"},onClick:()=>E(!0),children:[o.jsx(x,{icon:Ae})," Reporte"]})]}),o.jsxs("div",{className:"d-flex mb-3",children:[o.jsxs(Se,{children:[o.jsx(x,{icon:_e})," "]}),o.jsx(H,{placeholder:"Buscar Historiales...",value:u,onChange:e=>{const r=e.target.value.toUpperCase();if(/[^A-ZÁÉÍÓÚ´Ñ0-9\s]/g.test(r)){m.fire({icon:"error",title:"Carácter no permitido",text:"Solo se permiten letras, tildes, números y espacios."});return}if(/(.)\1{3,}/g.test(r)){m.fire({icon:"error",title:"Demasiadas repeticiones",text:"No puedes ingresar más de tres veces la misma letra consecutiva."});return}O(r)},style:{width:"200px"}}),o.jsxs(l,{onClick:se,style:{border:"1px solid #ccc",transition:"all 0.1s ease-in-out",backgroundColor:"#F3F4F7",color:"#343a40"},children:[o.jsx(x,{icon:Ee})," Limpiar"]})," "]}),o.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",alignItems:"center",fontSize:"small",marginBottom:"10px"},children:[o.jsx("span",{children:"Mostrar"}),o.jsxs(f,{"aria-label":"Items por página",value:j,onChange:e=>{W(Number(e.target.value)),g(1)},style:{width:"auto",margin:"0 8px"},children:[o.jsx("option",{value:"5",children:"5"}),o.jsx("option",{value:"10",children:"10"}),o.jsx("option",{value:"20",children:"20"})]}),o.jsx("span",{children:"historiales"})]}),o.jsx("div",{className:"table-container",style:{overflowY:"auto",marginBottom:"20px"},children:o.jsxs(ye,{striped:!0,bordered:!0,hover:!0,responsive:!0,style:{minWidth:"700px",fontSize:"16px"},children:[o.jsx(ve,{children:o.jsxs(F,{children:[o.jsx(c,{children:"#"}),o.jsx(c,{children:"Código de Historial"}),o.jsx(c,{children:"Estado"}),o.jsx(c,{children:"Estudiante"}),o.jsx(c,{children:"Grado"}),o.jsx(c,{children:"Año Académico"}),o.jsx(c,{children:"Promedio Anual"}),o.jsx(c,{children:"Fecha Registro"}),o.jsx(c,{children:"Instituto"}),o.jsx(c,{children:"Acciones"})]})}),o.jsx(Pe,{children:ue.map((e,r)=>o.jsxs(F,{children:[o.jsx(d,{children:T+r+1}),o.jsx(d,{children:e.Cod_historial_academico}),o.jsx(d,{children:he(e.Cod_estado)}),o.jsx(d,{children:e.Estudiante}),o.jsx(d,{children:e.Grado}),o.jsx(d,{children:e.Año_Academico}),o.jsx(d,{children:e.Promedio_Anual}),o.jsx(d,{children:new Date(e.Fecha_Registro).toLocaleDateString("es-ES")}),o.jsx(d,{children:e.Instituto}),o.jsxs(d,{children:[o.jsx(l,{color:"info",onClick:()=>pe(e),children:o.jsx(x,{icon:Oe})}),o.jsx(l,{color:"danger",onClick:()=>Ce(e.Cod_historial_academico),children:o.jsx(x,{icon:we})})]})]},r))})]})}),o.jsx("nav",{children:o.jsxs("ul",{className:"pagination justify-content-center align-items-center",children:[o.jsx("li",{className:`page-item ${n===1?"disabled":""}`,children:o.jsx("button",{className:"page-link",style:{backgroundColor:n===1?"rgba(111, 129, 115, 0.5)":"#6f8173",color:"#D9EAD3",borderRadius:"5px",transition:"background-color 0.3s ease"},onMouseEnter:e=>e.target.style.backgroundColor="#4b5b52",onMouseLeave:e=>e.target.style.backgroundColor=n===1?"rgba(111, 129, 115, 0.5)":"#6f8173",onClick:()=>g(n-1),disabled:n===1,children:"Anterior"})}),o.jsx("li",{className:`page-item ${n===v?"disabled":""}`,children:o.jsx("button",{className:"page-link",style:{backgroundColor:"#6f8173",color:"#D9EAD3",borderRadius:"5px",transition:"background-color 0.3s ease"},onMouseEnter:e=>e.target.style.backgroundColor="#4b5b52",onMouseLeave:e=>e.target.style.backgroundColor="#6f8173",onClick:()=>g(n+1),disabled:n===v,children:"Siguiente"})}),o.jsx("li",{className:"page-item",children:o.jsxs("span",{style:{margin:"0 10px",color:"#6f8173"},children:["Página ",n," de ",v]})})]})}),o.jsxs(B,{visible:J,onClose:G,backdrop:"static",keyboard:!1,children:[o.jsx(L,{children:o.jsx(z,{children:y?"Editar Historial":"Agregar Historial"})}),o.jsx($,{children:o.jsxs(Ne,{children:[o.jsxs(f,{label:"Estudiante",value:i.Estudiante,onChange:e=>b({...i,Estudiante:e.target.value}),children:[o.jsx("option",{children:"Seleccione un estudiante"}),K.map(e=>o.jsx("option",{value:`${e.Nombre} ${e.Segundo_nombre||""} ${e.Primer_apellido} ${e.Segundo_Apellido||""}`.trim(),children:`${e.Nombre} ${e.Segundo_nombre||""} ${e.Primer_apellido} ${e.Segundo_Apellido||""}`.trim()},e.cod_persona))]}),o.jsxs(f,{label:"Grado",value:i.cod_grado,onChange:e=>_(e,"Cod_grado"),children:[o.jsx("option",{value:"",children:"Seleccione una opción"}),X.map(e=>o.jsx("option",{value:e.Cod_grado,children:e.Nombre_grado},e.Cod_grado))]}),o.jsx(f,{label:"Año Académico",value:i.Año_Academico,onChange:e=>_(e,"Año_Academico"),children:fe().map(e=>o.jsx("option",{value:e,children:e},e))}),o.jsx(H,{label:"Promedio Anual",type:"number",value:i.Promedio_Anual,onChange:e=>_(e,"Promedio_Anual")}),o.jsxs(f,{label:"Instituto",value:i.Instituto,onChange:e=>_(e,"Instituto"),children:[o.jsx("option",{value:"",children:"Seleccione una opción"}),w.length>0?w.map((e,r)=>o.jsx("option",{value:e.Nom_Instituto,children:e.Nom_Instituto},r)):o.jsx("option",{children:"Cargando institutos..."})]})]})}),o.jsxs(U,{children:[o.jsx(l,{color:"secondary",onClick:G,children:"Cancelar"}),o.jsx(l,{color:"primary",onClick:y?xe:me,children:y?"Actualizar":"Crear"})]})]}),o.jsxs(B,{visible:Q,onClose:()=>E(!1),backdrop:"static",keyboard:!1,children:[o.jsx(L,{children:o.jsx(z,{children:"Generar Reporte"})}),o.jsx($,{children:o.jsx("p",{children:"Seleccione el formato para descargar el reporte:"})}),o.jsxs(U,{children:[o.jsx(l,{color:"primary",onClick:downloadPDF,children:"PDF"}),o.jsx(l,{color:"primary",onClick:downloadExcel,children:"Excel"}),o.jsx(l,{color:"secondary",onClick:()=>E(!1),children:"Cerrar"})]})]})]})};export{no as default};
