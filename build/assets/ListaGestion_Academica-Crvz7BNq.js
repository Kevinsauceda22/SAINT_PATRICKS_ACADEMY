import{r as l,o as he,j as o,i as ue}from"./index-SVRFFNc9.js";import{C as b}from"./index.esm-DWwMdKxH.js";import{S as n}from"./sweetalert2.esm.all-D3pEHXw3.js";import{E as Z}from"./jspdf.plugin.autotable-gke1D7B3.js";import{l as q}from"./logo_saint_patrick-xw7Wl8f3.js";import xe from"./AccessDenied-yaDW3Jao.js";import{u as fe}from"./usePermission-BCWksQX7.js";import{C as Ce}from"./CContainer-BdNP0s3v.js";import{C as M,a as v}from"./CRow-Bf67u6lu.js";import{c as be}from"./cil-book-B7CyeEjX.js";import{a as d}from"./CButton-D9GPTbB6.js";import{c as Se}from"./cil-plus-D8mtC-W5.js";import{c as je}from"./cil-description-MUzg6O3n.js";import{C as Q}from"./CInputGroup-D-McUFva.js";import{C as we}from"./CInputGroupText-Cfu0fzaY.js";import{c as ye}from"./cil-search-CDkY_4k-.js";import{C as Ne}from"./CFormInput-B_gylY64.js";import{C as ee}from"./CFormSelect-CzT7g5tb.js";import{C as Ae,a as Ee}from"./CCardBody-BwCgYaTs.js";import{C as ve,a as Te,b as G,c as S,d as Pe,e as h}from"./CTable-98qqrSRH.js";import{c as ke}from"./cil-settings-CNy3J7AJ.js";import{c as De}from"./cil-arrow-circle-bottom-eSdqpImC.js";import{C as _e,a as ze,b as Fe,c as Re}from"./CModalHeader-Bhtr3bZe.js";import{C as $e}from"./CModalTitle-M2mBvD_5.js";import"./CFormControlWrapper-OEJgTi6e.js";import"./CFormControlValidation-CtDkyDfm.js";import"./CFormLabel-szm2Dda9.js";import"./CBackdrop-BbuVwMMD.js";import"./CConditionalPortal-DwBsYzTA.js";const Ie=u=>{try{const i=u.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),m=decodeURIComponent(atob(i).split("").map(j=>`%${`00${j.charCodeAt(0).toString(16)}`.slice(-2)}`).join(""));return JSON.parse(m)}catch(x){return console.error("Error al decodificar el token JWT:",x),null}},Le=async(u,x="")=>{try{const i=localStorage.getItem("token"),m=Ie(i);if(!m){n.fire("Error","Token inválido o expirado. Por favor, inicie sesión nuevamente.","error");return}const j=m.cod_usuario,T=m.nombre_usuario;if(!j||!T){n.fire("Error","El token no contiene información válida del usuario.","error");return}const R=`El usuario: ${T} realizó la acción: ${u}. ${x}`;await ue.post("http://localhost:4000/api/bitacora/registro",{cod_usuario:j,cod_objeto:96,accion:u,descripcion:R},{headers:{Authorization:`Bearer ${i}`}})}catch(i){console.error("Error al registrar en bitácora:",i.message),n.fire("Error","Hubo un problema al registrar en la bitácora.","error")}},uo=()=>{const{canSelect:u,canInsert:x}=fe("gestion_academica"),[i,m]=l.useState([]),[j,T]=l.useState([]),[R,P]=l.useState(!1),[U,oe]=l.useState({totalSecciones:"",periodo:""}),te=he(),[f,H]=l.useState(1),[C,re]=l.useState(5),[W,O]=l.useState(""),[ae,ne]=l.useState("Total_secciones");l.useEffect(()=>{Y(),se()},[]);const Y=async()=>{try{const e=await fetch("http://localhost:4000/api/gestion_academica/obtenerTodasAgrupaciones");if(!e.ok)throw new Error("Error en la respuesta del servidor");const t=await e.json();m(t)}catch(e){console.error("Error en fetchAgrupadores:",e);const t=e.message.includes("Failed to fetch")?"No se pudo conectar al servidor. Verifica tu conexión a Internet.":"Hubo un problema al obtener los agrupadores. Por favor, inténtalo más tarde.";n.fire("Error",t,"error")}},se=async()=>{try{const e=await fetch("http://localhost:4000/api/gestion_academica/obtener_periodo");if(!e.ok)throw new Error("Error en la respuesta del servidor");const t=await e.json();T(t)}catch(e){console.error("Error en fetchPeriodos:",e);const t=e.message.includes("Failed to fetch")?"No se pudo conectar al servidor para obtener los periodos. Verifica tu conexión.":"Hubo un problema al cargar los periodos. Inténtalo nuevamente más tarde.";n.fire("Error",t,"error")}},ie=e=>{te("/lista-secciones/",{state:{periodoSeleccionado:e}})},ce=async e=>{try{const t=await fetch(`http://localhost:4000/api/gestion_academica/detalle/${e}`);if(!t.ok)throw new Error(`Error al obtener datos del período: ${t.status}`);const c=(await t.json()).Anio_academico||"Sin Año Académico",w=await fetch(`http://localhost:4000/api/gestion_academica/secciones_por_periodo/${e}`);if(!w.ok)throw new Error(`Error al obtener datos del servidor: ${w.status}`);const I=await w.json(),r=new Z,p=new Image;p.src=q,p.onload=()=>{const a=r.internal.pageSize.width;r.addImage(p,"PNG",10,10,45,45),r.setFontSize(18),r.setTextColor(0,102,51),r.text("SAINT PATRICK'S ACADEMY",a/2,24,{align:"center"}),r.setFontSize(10),r.setTextColor(100),r.text("Casa Club del periodista, Colonia del Periodista",a/2,32,{align:"center"}),r.text("Teléfono: (504) 2234-8871",a/2,37,{align:"center"}),r.text("Correo: info@saintpatrickacademy.edu",a/2,42,{align:"center"}),r.setFontSize(14),r.setTextColor(0,102,51),r.text(`Listado de Secciones - Año Académico ${c}`,a/2,50,{align:"center"}),r.setLineWidth(.5),r.setDrawColor(0,102,51),r.line(10,55,a-10,55);const y=["#","Sección","Aula","Grado","Maestro guía"],L=I.map((g,B)=>{var z,A,E,F;return[{content:(B+1).toString(),styles:{halign:"center"}},{content:((z=g.Nombre_seccion)==null?void 0:z.toUpperCase())||"SIN NOMBRE",styles:{halign:"center"}},{content:((A=g.Aula)==null?void 0:A.toString())||"SIN AULA",styles:{halign:"center"}},((E=g.Grado)==null?void 0:E.toUpperCase())||"SIN GRADO",{content:((F=g.Profesor)==null?void 0:F.toUpperCase())||"SIN PROFESOR",styles:{halign:"left"}}]});r.autoTable({startY:70,head:[y],body:L,headStyles:{fillColor:[0,102,51],textColor:[255,255,255],fontSize:10,halign:"center"},styles:{fontSize:10,cellPadding:3},alternateRowStyles:{fillColor:[240,248,255]},didDrawPage:g=>{const B=r.internal.getNumberOfPages(),z=r.internal.getCurrentPageInfo().pageNumber,A=r.internal.pageSize.height-10;r.setFontSize(10),r.setTextColor(0,102,51),r.text(`Página ${z} de ${B}`,a-10,A,{align:"right"});const E=new Date,F=E.toLocaleDateString("es-HN",{year:"numeric",month:"long",day:"numeric"}),ge=E.toLocaleTimeString("es-HN",{hour:"2-digit",minute:"2-digit",second:"2-digit"});r.text(`Fecha de generación: ${F} Hora: ${ge}`,10,A)}});const D=r.output("blob"),N=URL.createObjectURL(D),_=window.open("","_blank");_.document.title=`Reporte de Secciones - Año ${c}`,_.document.write(`
          <html>
            <head>
              <title>Reporte de Secciones - Año ${c}</title>
              <style>
                body {
                  margin: 0;
                  padding: 0;
                  overflow: hidden;
                }
                iframe {
                  width: 100%;
                  height: 100%;
                  border: none;
                }
                .download-button {
                  position: fixed;
                  top: 10px;
                  right: 10px;
                  background-color: #6c757d;
                  color: white;
                  border: none;
                  padding: 10px 15px;
                  border-radius: 5px;
                  cursor: pointer;
                }
              </style>
            </head>
            <body>
              <iframe src="${N}"></iframe>
              <button class="download-button" 
                onclick="const a = document.createElement('a'); a.href='${N}'; a.download='Reporte_Secciones_${c}.pdf'; a.click();">
                Descargar PDF
              </button>
            </body>
          </html>
        `)},p.onerror=()=>{n.fire("Error","No se pudo cargar el logo del encabezado. Verifica la ruta o la conexión.","error")}}catch(t){console.error("Error en handleDescargarPDF:",t);const s=t.message.includes("Error al obtener datos del período")?"No se pudo obtener la información del período académico. Verifica los datos.":"No se pudieron cargar las secciones para generar el PDF. Inténtalo nuevamente.";n.fire("Error",s,"error")}},le=()=>{const e=new Z,t=new Image;t.src=q,t.onload=()=>{const s=e.internal.pageSize.width;e.addImage(t,"PNG",10,10,45,45),e.setFontSize(18),e.setTextColor(0,102,51),e.text("SAINT PATRICK'S ACADEMY",s/2,24,{align:"center"}),e.setFontSize(10),e.setTextColor(100),e.text("Casa Club del periodista, Colonia del Periodista",s/2,32,{align:"center"}),e.text("Teléfono: (504) 2234-8871",s/2,37,{align:"center"}),e.text("Correo: info@saintpatrickacademy.edu",s/2,42,{align:"center"}),e.setFontSize(14),e.setTextColor(0,102,51),e.text("Reporte de Gestión Académica",s/2,50,{align:"center"}),e.setLineWidth(.5),e.setDrawColor(0,102,51),e.line(10,55,s-10,55);const c=["#","Total Secciones","Año Académico","Fecha de Creación","Estado"],w=X.map((a,y)=>[{content:y+1,styles:{halign:"center"}},{content:a.Total_secciones.toString(),styles:{halign:"center"}},{content:a.Anio_academico.toString(),styles:{halign:"center"}},{content:new Date(a.Fecha_agrupacion).toLocaleDateString(),styles:{halign:"center"}},{content:a.Estado,styles:{halign:"center",textColor:a.Estado==="Activo"?[0,128,0]:[255,0,0],fontStyle:a.Estado==="Activo"?"bold":"normal"}}]);e.autoTable({startY:70,head:[c],body:w,headStyles:{fillColor:[0,102,51],textColor:[255,255,255],fontSize:10,halign:"center"},styles:{fontSize:10,cellPadding:3},alternateRowStyles:{fillColor:[240,248,255]},didDrawPage:a=>{const y=e.internal.getNumberOfPages(),L=e.internal.getCurrentPageInfo().pageNumber,D=e.internal.pageSize.height-10;e.setFontSize(10),e.setTextColor(0,102,51),e.text(`Página ${L} de ${y}`,s-10,D,{align:"right"});const N=new Date,_=N.toLocaleDateString("es-HN",{year:"numeric",month:"long",day:"numeric"}),g=N.toLocaleTimeString("es-HN",{hour:"2-digit",minute:"2-digit",second:"2-digit"});e.text(`Fecha de generación: ${_} Hora: ${g}`,10,D)}});const I=e.output("blob"),r=URL.createObjectURL(I),p=window.open(r,"_blank");p&&(p.document.title="Reporte de Gestión Académica")},t.onerror=()=>{n.fire("Error","No se pudo cargar el logo.","error")}},de=()=>{oe({totalSecciones:"",periodo:""})},$=()=>{U.totalSecciones||U.periodo?n.fire({title:"¿Estás seguro?",text:"Perderás todos los datos ingresados si cierras el modal.",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, cerrar",cancelButtonText:"No, continuar"}).then(e=>{e.isConfirmed&&(de(),P(!1))}):P(!1)},V=e=>{e>0&&e<=Math.ceil(k.length/C)&&H(e)},J=e=>e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(),k=i.filter(e=>{var c;const t=J(W);return J(((c=e[ae])==null?void 0:c.toString())||"").includes(t)}),K=f*C,me=K-C,X=k.slice(me,K),pe=async()=>{try{const e=await fetch("http://localhost:4000/api/gestion_academica/crear_agrupador",{method:"POST"}),t=await e.json();if(!e.ok){n.fire("Advertencia",t.mensaje||"No se pudo crear el agrupador.","warning");return}await Le("INSERT","Se creó un nuevo agrupador en la gestión académica."),n.fire("Éxito","Agrupador creado exitosamente.","success"),Y(),P(!1)}catch{n.fire("Error","Hubo un problema al crear el agrupador.","error")}};return u?o.jsxs(Ce,{style:{marginTop:"10px",maxWidth:"900px"},children:[o.jsx(M,{className:"align-items-center justify-content-center mb-2",children:o.jsx(v,{xs:"12",className:"text-center",children:o.jsxs("h2",{className:"fw-bold",style:{color:"#333"},children:[o.jsx(b,{icon:be,className:"me-1"}),"Gestión Académica"]})})}),o.jsx(M,{className:"align-items-center mb-4",style:{marginTop:"-10px"},children:o.jsxs(v,{xs:"12",className:"d-flex justify-content-between",children:[x&&o.jsxs(d,{className:"d-flex align-items-center gap-1 rounded shadow",style:{backgroundColor:"#4B6251",color:"white",padding:"10px 16px",fontSize:"0.9rem"},onClick:()=>P(!0),children:[o.jsx(b,{icon:Se})," Nuevo"]}),o.jsxs(d,{className:"d-flex align-items-center rounded shadow",style:{backgroundColor:"#6C8E58",color:"white",padding:"10px 16px",fontSize:"0.9rem"},onClick:le,children:[o.jsx(b,{icon:je})," Reporte"]})]})}),o.jsxs(M,{className:"align-items-center mb-4",children:[o.jsx(v,{xs:"12",md:"2",className:"text-start",children:o.jsx(d,{color:"light",onClick:()=>{O("")},style:{padding:"6px 12px",fontSize:"0.9rem",backgroundColor:"#E0E0E0",color:"#000",border:"1px solid #CCC"},children:"Limpiar"})}),o.jsx(v,{xs:"12",md:"6",className:"d-flex align-items-center gap-2",children:o.jsxs(Q,{children:[o.jsx(we,{children:o.jsx(b,{icon:ye})}),o.jsx(Ne,{placeholder:"Buscar Agrupador...",value:W,onChange:e=>{let t=e.target.value;t=t.toUpperCase(),t=t.replace(/[^A-Z0-9 ]/g,""),t=t.normalize("NFD").replace(/[\u0300-\u036f]/g,""),t=t.replace(/(.)\1{3,}/g,"$1$1$1"),t=t.replace(/\s{2,}/g," "),O(t)},style:{padding:"6px",fontSize:"0.9rem"}}),o.jsxs(ee,{"aria-label":"Buscar por",onChange:e=>ne(e.target.value),style:{marginLeft:"10px",fontSize:"0.9rem"},children:[o.jsx("option",{value:"Total_secciones",children:"Total de secciones"}),o.jsx("option",{value:"Anio_academico",children:"Año Académico"})]})]})}),o.jsx(v,{xs:"12",md:"4",className:"text-md-end mt-3 mt-md-0",children:o.jsx(Q,{style:{width:"auto",display:"inline-block"},children:o.jsxs("div",{className:"d-inline-flex align-items-center",children:[o.jsx("span",{children:"Mostrar "}),o.jsxs(ee,{style:{width:"80px",display:"inline-block",textAlign:"center",fontSize:"0.9rem"},onChange:e=>{const t=Number(e.target.value);re(t),H(1)},value:C,children:[o.jsx("option",{value:"5",children:"5"}),o.jsx("option",{value:"10",children:"10"}),o.jsx("option",{value:"20",children:"20"})]}),o.jsx("span",{children:" registros"})]})})})]}),o.jsx(Ae,{children:o.jsx(Ee,{children:o.jsx("div",{className:"table-container mt-4",style:{overflowX:"auto",marginBottom:"20px"},children:o.jsxs(ve,{striped:!0,bordered:!0,hover:!0,children:[o.jsx(Te,{children:o.jsxs(G,{children:[o.jsx(S,{className:"text-center",children:"#"}),o.jsx(S,{className:"text-center",children:"Total Secciones"}),o.jsx(S,{className:"text-center",children:"Año Académico"}),o.jsx(S,{className:"text-center",children:"Fecha de Creación"}),o.jsx(S,{className:"text-center",children:"Estado"}),o.jsx(S,{className:"text-center",children:"Acciones"})]})}),o.jsx(Pe,{children:i.length>0?X.map((e,t)=>o.jsxs(G,{style:{backgroundColor:e.Estado==="Activo"?"#eaffea":"inherit",fontWeight:e.Estado==="Activo"?"bold":"normal"},children:[o.jsx(h,{className:"text-center",children:t+1}),o.jsx(h,{className:"text-center",children:e.Total_secciones}),o.jsx(h,{className:"text-center",children:e.Anio_academico}),o.jsx(h,{className:"text-center",children:new Date(e.Fecha_agrupacion).toLocaleDateString()}),o.jsx(h,{className:"text-center",children:o.jsx("span",{style:{color:e.Estado==="Activo"?"green":"red",fontWeight:e.Estado==="Activo"?"bold":"normal"},children:e.Estado})}),o.jsx(h,{className:"text-center",children:o.jsxs("div",{className:"d-flex justify-content-center gap-2",children:[o.jsx(d,{color:"info",onClick:()=>ie(e.Cod_periodo_matricula),className:"d-flex align-items-center",children:o.jsx(b,{icon:ke})}),o.jsxs(d,{color:"warning",onClick:()=>ce(e.Cod_periodo_matricula),className:"d-flex align-items-center",children:[o.jsx(b,{icon:De,className:"me-1"})," PDF"]})]})})]},e.Cod_agrupadora)):o.jsx(G,{children:o.jsx(h,{colSpan:"6",className:"text-center",children:"No hay agrupadores disponibles."})})})]})})})}),o.jsxs("div",{className:"pagination-container",style:{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",marginTop:"20px"},children:[o.jsxs("div",{style:{display:"flex",gap:"10px",marginBottom:"10px"},children:[o.jsx(d,{style:{backgroundColor:"#6f8173",color:"#D9EAD3",padding:"8px 16px",borderRadius:"8px",fontSize:"0.9rem",fontWeight:"bold"},disabled:f===1,onClick:()=>V(f-1),children:"Anterior"}),o.jsx(d,{style:{backgroundColor:"#6f8173",color:"#D9EAD3",padding:"8px 16px",borderRadius:"8px",fontSize:"0.9rem",fontWeight:"bold"},disabled:f===Math.ceil(k.length/C),onClick:()=>V(f+1),children:"Siguiente"})]}),o.jsxs("span",{style:{fontSize:"0.9rem",color:"#6f8173"},children:["Página ",f," de ",Math.ceil(k.length/C)]})]}),o.jsxs(_e,{visible:R,onClose:$,backdrop:"static",children:[o.jsx(ze,{onClose:$,children:o.jsx($e,{children:"Crear Nuevo Agrupador"})}),o.jsx(Fe,{children:o.jsx("p",{children:"Este proceso agrupará automáticamente las secciones del periodo académico activo. ¿Deseas continuar?"})}),o.jsxs(Re,{children:[o.jsx(d,{color:"secondary",onClick:$,children:"Cancelar"}),o.jsx(d,{color:"primary",onClick:pe,children:"Confirmar"})]})]})]}):o.jsx(xe,{})};export{Ie as decodeJWT,uo as default};
