import{r as i,j as t,C as ye}from"./index-SVRFFNc9.js";import{S as c}from"./sweetalert2.esm.all-D3pEHXw3.js";import{C as u}from"./index.esm-DWwMdKxH.js";import{E as we}from"./jspdf.plugin.autotable-gke1D7B3.js";import{l as De}from"./logo_saint_patrick-xw7Wl8f3.js";import{u as Se}from"./usePermission-BCWksQX7.js";import Ee from"./AccessDenied-yaDW3Jao.js";import{C as N}from"./CContainer-BdNP0s3v.js";import{C as j,a as h}from"./CRow-Bf67u6lu.js";import{a as m}from"./CButton-D9GPTbB6.js";import{c as Ne}from"./cil-plus-D8mtC-W5.js";import{c as Te}from"./cil-file-CeQgYs_D.js";import{C as T}from"./CInputGroup-D-McUFva.js";import{C as $}from"./CInputGroupText-Cfu0fzaY.js";import{c as ke}from"./cil-search-CDkY_4k-.js";import{C as O}from"./CFormInput-B_gylY64.js";import{C as ve}from"./CFormSelect-CzT7g5tb.js";import{C as Pe,a as ze,b as H,c as k,d as Me,e as v}from"./CTable-98qqrSRH.js";import{c as _e}from"./cil-pen-53d2I-C-.js";import{c as Fe}from"./cil-trash-CBbKHhHb.js";import{C as Le}from"./CPagination-UopCEeNZ.js";import{C as Ie,a as Re,b as Ae,c as Be}from"./CModalHeader-Bhtr3bZe.js";import{C as Ue}from"./CModalTitle-M2mBvD_5.js";import{C as $e}from"./CForm-CYRkMwLo.js";import{c as Oe}from"./cil-save-CHBg7z_U.js";import"./CFormControlWrapper-OEJgTi6e.js";import"./CFormControlValidation-CtDkyDfm.js";import"./CFormLabel-szm2Dda9.js";import"./CBackdrop-BbuVwMMD.js";import"./CConditionalPortal-DwBsYzTA.js";const jt=()=>{const{canSelect:G,canUpdate:V,canDelete:W,canInsert:Y}=Se("departamento"),[y,q]=i.useState([]),[J,K]=i.useState(!0),[P,Z]=i.useState(""),[Q,X]=i.useState(""),[w,z]=i.useState([]),[l,x]=i.useState(0),[d,ee]=i.useState(5),[te,p]=i.useState(!1),[D,M]=i.useState(!1),[S,g]=i.useState({codDepartamento:null,nombreDepartamento:""}),f=async()=>{try{const e=await fetch("http://74.50.68.87:4000/api/departamento/departamentos"),r=await e.json();if(e.ok){const a=r.map(s=>({...s,nombre_departamento:s.nombre_departamento.toUpperCase()})).reduce((s,C)=>s.find(b=>b.cod_departamento===C.cod_departamento)?s:s.concat([C]),[]);q(a),z(a)}else throw new Error(r.message||"Error al obtener los departamentos")}catch(e){Z(e.message),c.fire("Error",e.message,"error")}finally{K(!1)}},_=()=>{n("")},re=async()=>{_();const{nombreDepartamento:e}=S;if(y.find(o=>o.nombre_departamento.toLowerCase()===e.toLowerCase()))return n("Ya existe un Departamento con ese nombre."),setTimeout(()=>n(""),5e3),e.slice(0,e.length-1);n("");try{c.fire("Éxito","Departamento creado exitosamente","success")}catch{c.fire("Error","Ocurrió un problema al crear el departamento","error")}try{const o=await fetch("http://74.50.68.87:4000/api/departamento/departamentos",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nombre_departamento:e})});if(o.ok)c.fire("Éxito","Departamento creado exitosamente","success"),f();else{const a=await o.json();throw new Error(a.message||"Error al crear el departamento")}}catch(o){c.fire("Error",o.message,"error")}finally{p(!1)}},oe=async()=>{_();const{codDepartamento:e,nombreDepartamento:r}=S;if(!r){c.fire("Error","El nombre del departamento es requerido","error");return}try{const o=await fetch(`http://74.50.68.87:4000/api/departamento/departamentos/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({nombre_departamento:r})});if(o.ok)c.fire("Éxito","Departamento actualizado exitosamente","success"),f();else{const a=await o.json();throw new Error(a.message||"Error al actualizar el departamento")}}catch(o){c.fire("Error",o.message,"error")}finally{p(!1)}},ae=async e=>{try{if((await fetch(`http://74.50.68.87:4000/api/departamento/departamentos/${e}`,{method:"DELETE"})).ok)c.fire("Éxito","Departamento eliminado correctamente","success"),f();else throw new Error("Error al eliminar el departamento")}catch(r){c.fire("Error",r.message,"error")}},ne=e=>{c.fire({title:"¿Estás seguro?",text:"No podrás revertir esta acción",icon:"warning",showCancelButton:!0,confirmButtonText:"Eliminar",cancelButtonText:"Cancelar"}).then(r=>{r.isConfirmed&&ae(e)})},se=e=>{const r=e.target.value.toLowerCase();X(r);const o=y.filter(a=>a.nombre_departamento.toLowerCase().includes(r));z(o),x(0)},ie=()=>{g({codDepartamento:null,nombreDepartamento:""}),M(!1),p(!0)},ce=e=>{g({codDepartamento:e.cod_departamento,nombreDepartamento:e.nombre_departamento}),M(!0),p(!0)},F=e=>{e.preventDefault(),n("Copiar y pegar no está permitido."),setTimeout(()=>n(""),5e3)},[L,n]=i.useState(""),le=e=>/(.)\1\1/.test(e),me=e=>/^[a-zA-Z0-9\s]*$/.test(e),de=e=>/\s{3,}/.test(e),pe=e=>/\d/.test(e),ue=e=>{const{name:r,value:o}=e.target,a=o.toUpperCase();if(n(""),a.trim()===""){g(s=>({...s,[r]:a}));return}if(de(a)){n("No se permiten más de 2 espacios consecutivos"),setTimeout(()=>n(""),5e3);return}if(le(a)){n("No se permiten mas de 2 letras consecutivas iguales"),setTimeout(()=>n(""),5e3);return}if(!me(a)){n("No se permiten caracteres especiales"),setTimeout(()=>n(""),5e3);return}if(pe(a)){n("No se permiten números."),setTimeout(()=>n(""),5e3);return}g(s=>({...s,[r]:a}))},he=e=>{e.preventDefault(),D?oe():re()},xe=()=>{const e=new we({orientation:"landscape",unit:"mm",format:"a4"}),r=new Image;r.src=De,r.onload=()=>{const o=e.internal.pageSize.width,a=e.internal.pageSize.height;e.addImage(r,"PNG",10,10,45,45),e.setFontSize(18),e.setTextColor(0,102,51),e.text("SAINT PATRICK'S ACADEMY",o/2,24,{align:"center"}),e.setFontSize(10),e.setTextColor(100),e.text("Casa Club del periodista, Colonia del Periodista",o/2,32,{align:"center"}),e.text("Teléfono: (504) 2234-8871",o/2,37,{align:"center"}),e.text("Correo: info@saintpatrickacademy.edu",o/2,42,{align:"center"}),e.setFontSize(14),e.setTextColor(0,102,51),e.text("Reporte de Departamentos",o/2,50,{align:"center"}),e.setLineWidth(.5),e.setDrawColor(0,102,51),e.line(10,55,o-10,55),e.setFontSize(12),e.setTextColor(0),e.text("Listado de Departamentos",o/2,65,{align:"center"});const s=["#","Departamento"],C=y.map((B,E)=>[{content:(E+1).toString(),styles:{halign:"center"}},{content:(B.nombre_departamento||"Sin nombre").toUpperCase(),styles:{halign:"left"}}]);e.autoTable({startY:75,head:[s],body:C,headStyles:{fillColor:[0,102,51],textColor:[255,255,255],fontSize:10,halign:"center"},styles:{fontSize:10,cellPadding:3},alternateRowStyles:{fillColor:[240,248,255]},columnStyles:{1:{halign:"center"}},margin:{top:10,bottom:30},didDrawPage:function(B){const E=e.internal.getNumberOfPages(),Ce=e.internal.getCurrentPageInfo().pageNumber;e.setFontSize(10),e.setTextColor(0,102,51),e.text(`Página ${Ce} de ${E}`,o-10,a-10,{align:"right"});const U=new Date,be=U.toLocaleDateString("es-HN",{year:"numeric",month:"long",day:"numeric"}),je=U.toLocaleTimeString("es-HN",{hour:"2-digit",minute:"2-digit",second:"2-digit"});e.text(`Fecha de generación: ${be} Hora: ${je}`,10,a-10)}});const A=e.output("blob"),b=URL.createObjectURL(A);window.open("","_blank").document.write(`
      <html>
        <head><title>Reporte de Departamentos</title></head>
        <body style="margin:0;">
          <iframe width="100%" height="100%" src="${b}" frameborder="0"></iframe>
          <div style="position:fixed;top:10px;right:200px;">
            <button style="background-color: #6c757d; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;" 
              onclick="const a = document.createElement('a'); a.href='${b}'; a.download='Reporte_de_Departamentos.pdf'; a.click();">
              Descargar PDF
            </button>
          </div>
        </body>
      </html>`)},r.onerror=()=>{swal.fire("Error","No se pudo cargar el logo.","error")}};i.useEffect(()=>{f()},[]);const I=(l+1)*d,ge=I-d,fe=w.slice(ge,I);if(J)return t.jsx(N,{children:t.jsx(j,{className:"justify-content-center",children:t.jsxs(h,{xs:12,md:6,children:[t.jsx(ye,{color:"primary"}),t.jsx("p",{children:"Cargando departamentos..."})]})})});if(P)return t.jsx(N,{children:t.jsx(j,{className:"justify-content-center",children:t.jsx(h,{xs:12,md:6,children:t.jsxs("p",{children:["Error: ",P]})})})});const R=Math.ceil(w.length/d);return G?t.jsxs(N,{children:[t.jsxs(j,{className:"justify-content-between align-items-center mb-3 sticky-header",children:[t.jsx(h,{xs:12,md:8,children:t.jsx("h3",{children:"Mantenimiento de Departamentos"})}),t.jsxs(h,{xs:"4",md:"3",className:"text-end",children:[Y&&t.jsxs(m,{color:"dark",onClick:ie,className:"me-2",style:{backgroundColor:"#4B6251",borderColor:"#0F463A"},children:[t.jsx(u,{icon:Ne})," Nuevo"]}),t.jsxs(m,{color:"primary",onClick:xe,style:{backgroundColor:"#6C8E58",borderColor:"#617341"},children:[t.jsx(u,{icon:Te})," Generar Reporte"]})]})]}),t.jsxs(j,{className:"align-items-center my-3 sticky-header",children:[t.jsx(h,{md:5,children:t.jsxs(T,{size:"sm",children:[t.jsx($,{children:t.jsx(u,{icon:ke})}),t.jsx(O,{placeholder:"Buscar departamento",value:Q,onChange:se})]})}),t.jsx(h,{xs:"12",md:"7",className:"text-md-end mt-2 mt-md-0",children:t.jsx(T,{style:{width:"auto",display:"inline-block"},children:t.jsxs("div",{className:"d-inline-flex align-items-center",children:[t.jsx("span",{children:"Mostrar "}),t.jsxs(ve,{style:{width:"80px",display:"inline-block",textAlign:"center"},onChange:e=>{ee(Number(e.target.value)),x(0)},value:d,children:[t.jsx("option",{value:"5",children:"5"}),t.jsx("option",{value:"10",children:"10"}),t.jsx("option",{value:"20",children:"20"})]}),t.jsx("span",{children:" registros"})]})})})]}),t.jsx("div",{className:"table-container",children:t.jsxs(Pe,{striped:!0,bordered:!0,hover:!0,children:[t.jsx(ze,{children:t.jsxs(H,{children:[t.jsx(k,{children:"#"}),t.jsx(k,{children:"Nombre del Departamento"}),t.jsx(k,{className:"text-end",children:"Acciones"})]})}),t.jsx(Me,{children:fe.map((e,r)=>t.jsxs(H,{children:[t.jsx(v,{children:r+1+l*d}),t.jsx(v,{children:e.nombre_departamento.toUpperCase()}),t.jsxs(v,{className:"text-end",children:[V&&t.jsx(m,{color:"warning",size:"sm",style:{opacity:.8},onClick:()=>ce(e),children:t.jsx(u,{icon:_e})})," ",W&&r+1+l*d>=19&&t.jsx(m,{color:"danger",size:"sm",style:{opacity:.8},onClick:()=>ne(e.cod_departamento),children:t.jsx(u,{icon:Fe})})]})]},e.cod_departamento))})]})}),t.jsxs("nav",{className:"d-flex justify-content-center align-items-center mt-4",children:[t.jsxs(Le,{className:"mb-0",style:{gap:"0.3cm"},children:[t.jsx(m,{style:{backgroundColor:"gray",color:"white",marginRight:"0.3cm"},disabled:l===0,onClick:()=>x(l-1),children:"Anterior"}),t.jsx(m,{style:{backgroundColor:"gray",color:"white"},disabled:l===R-1,onClick:()=>x(l+1),children:"Siguiente"})]}),t.jsxs("span",{className:"mx-2",children:["Página ",l+1," de ",R]})]}),t.jsxs(Ie,{visible:te,onClose:()=>p(!1),backdrop:"static",children:[t.jsx(Re,{closeButton:!0,children:t.jsx(Ue,{children:D?"Editar Departamento":"Agregar Departamento"})}),t.jsx(Ae,{children:t.jsxs($e,{onSubmit:he,children:[t.jsxs(T,{className:"mb-3",children:[t.jsx($,{children:"Nombre del Departamento"}),t.jsx(O,{type:"text",name:"nombreDepartamento",onPaste:F,onCopy:F,placeholder:"Nombre del departamento",value:S.nombreDepartamento,onChange:ue,required:!0})]}),L&&t.jsx("div",{style:{color:"red",fontSize:"14px",marginTop:"8px",marginLeft:"5px",display:"block"},children:L}),t.jsxs(Be,{children:[t.jsx(m,{color:"secondary",onClick:()=>p(!1),children:"Cancelar"}),t.jsxs(m,{style:{backgroundColor:"#617341",color:"white"},type:"submit",children:[t.jsx(u,{icon:Oe})," ","Guardar"]})]})]})})]}),t.jsx("style",{jsx:!0,children:`
        .table-container {
          max-height: 400px;
          overflow-y: ${w.length>=5?"auto":"hidden"};
          overflow-x: hidden;
        }
      `})]}):t.jsx(Ee,{})};export{jt as default};
