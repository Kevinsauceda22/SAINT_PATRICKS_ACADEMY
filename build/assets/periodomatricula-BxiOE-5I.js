import{r as n,j as o}from"./index-SVRFFNc9.js";import{C as m}from"./index.esm-DWwMdKxH.js";import{S as s}from"./sweetalert2.esm.all-D3pEHXw3.js";import{E as te}from"./jspdf.plugin.autotable-gke1D7B3.js";import{u as T,w as se}from"./xlsx-lwdk4T0U.js";import{l as ce}from"./logo_saint_patrick-xw7Wl8f3.js";import{u as ne}from"./usePermission-BCWksQX7.js";import le from"./AccessDenied-yaDW3Jao.js";import{C as de}from"./CContainer-BdNP0s3v.js";import{C as Y,a as P}from"./CRow-Bf67u6lu.js";import{a as l}from"./CButton-D9GPTbB6.js";import{c as me}from"./cil-plus-D8mtC-W5.js";import{C as he,a as ue,b as pe,c as G}from"./CDropdownToggle-DlfIUTmX.js";import{c as fe}from"./cil-file-CeQgYs_D.js";import{C}from"./CInputGroup-D-McUFva.js";import{C as j}from"./CInputGroupText-Cfu0fzaY.js";import{c as xe}from"./cil-search-CDkY_4k-.js";import{C as S}from"./CFormInput-B_gylY64.js";import{c as Ce}from"./cil-brush-alt-CV61lKqC.js";import{C as H}from"./CFormSelect-CzT7g5tb.js";import{C as ge,a as je,b as N,c as g,d as _e,e as h}from"./CTable-98qqrSRH.js";import{c as we}from"./cil-pen-53d2I-C-.js";import{c as be}from"./cil-trash-CBbKHhHb.js";import{C as ye}from"./CPagination-UopCEeNZ.js";import{C as ve,a as Ee,b as Pe,c as Se}from"./CModalHeader-Bhtr3bZe.js";import{C as Fe}from"./CModalTitle-M2mBvD_5.js";import{C as ke}from"./CForm-CYRkMwLo.js";import{c as Ae}from"./cil-save-CHBg7z_U.js";import"./CConditionalPortal-DwBsYzTA.js";import"./CFormControlWrapper-OEJgTi6e.js";import"./CFormControlValidation-CtDkyDfm.js";import"./CFormLabel-szm2Dda9.js";import"./CBackdrop-BbuVwMMD.js";const ho=()=>{const{canSelect:O,loading:Te,canDelete:U,canInsert:$,canUpdate:q}=ne("ListaHistorial"),[_,M]=n.useState([]),[u,F]=n.useState([]),[J,D]=n.useState(""),[d,w]=n.useState(1),[p,V]=n.useState(5),[t,b]=n.useState({cod_periodo_matricula:"",fecha_inicio:"",fecha_fin:"",anio_academico:new Date().getFullYear(),estado:""}),[K,f]=n.useState(!1),[y,k]=n.useState(!1);n.useEffect(()=>{v()},[]);const v=async()=>{try{const a=await(await fetch("http://74.50.68.87:4000/api/periodomatricula/periodos")).json();M(a),F(a)}catch(e){console.error("Error al obtener los periodos de matrícula:",e)}},E=e=>{b({...t,[e.target.name]:e.target.value})},W=e=>{e.preventDefault(),y?I(e):X()},z=()=>{const e=new Date(t.fecha_inicio);return new Date(t.fecha_fin)<e?(s.fire("Error","La fecha fin no puede ser menor a la fecha inicio.","error"),!1):!0},X=async()=>{if(!z())return;if(u.some(a=>a.anio_academico===t.anio_academico&&a.estado.toLowerCase()==="activo")){s.fire("Error","Ya existe un periodo activo para el año académico "+t.anio_academico,"error");return}try{const a=await fetch("http://74.50.68.87:4000/api/periodomatricula/crearperiodomatricula",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(a.ok)s.fire("Éxito","Periodo de matrícula creado correctamente","success"),L(),v(),f(!1);else{const r=await a.json();s.fire("Error",r.Mensaje,"error")}}catch{s.fire("Error","Error al crear el periodo de matrícula","error")}},I=async e=>{if(z()){e.preventDefault();try{const a=t.cod_periodo_matricula;if(!a)throw new Error("El código del periodo de matrícula es obligatorio");if(u.some(i=>i.anio_academico===t.anio_academico&&i.estado.toLowerCase()==="activo"&&i.cod_periodo_matricula!==a)){s.fire("Error","Ya existe un periodo activo para el año académico "+t.anio_academico,"error");return}const c=await fetch(`http://74.50.68.87:4000/api/periodomatricula/periodos/${a}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({p_cod_periodo_matricula:a,p_fecha_inicio:t.fecha_inicio,p_fecha_fin:t.fecha_fin,p_anio_academico:t.anio_academico,p_estado:t.estado})});if(!c.ok){const i=await c.json();throw new Error(i.Mensaje||"Error al actualizar el periodo de matrícula")}const x=await c.json();s.fire("Éxito",x.Mensaje,"success"),L(),v(),f(!1),k(!1)}catch(a){console.error("Error al actualizar el periodo de matrícula:",a),s.fire("Error",a.message,"error")}}},L=()=>{b({cod_periodo_matricula:"",fecha_inicio:"",fecha_fin:"",anio_academico:new Date().getFullYear(),estado:""})},Q=e=>{const a=e.target.value.toLowerCase();D(a);const r=_.filter(c=>c.estado.toLowerCase().includes(a)||c.anio_academico.toString().includes(a));F(r),w(1)},B=u.slice((d-1)*p,d*p),R=e=>{e>0&&e<=Math.ceil(u.length/p)&&w(e)},Z=()=>{b({cod_periodo_matricula:"",fecha_inicio:"",fecha_fin:"",anio_academico:new Date().getFullYear(),estado:""}),k(!1),f(!1)},ee=e=>{b({cod_periodo_matricula:e.Cod_periodo_matricula,fecha_inicio:e.Fecha_inicio,fecha_fin:e.Fecha_fin,anio_academico:e.Anio_academico,estado:e.estado}),k(!0),f(!0)},oe=async e=>{if((await s.fire({title:"¿Estás seguro?",text:"Esta acción no se puede deshacer.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Eliminar"})).isConfirmed)try{const r=await fetch(`http://74.50.68.87:4000/api/periodomatricula/periodos/${e}`,{method:"DELETE"});if(r.ok)s.fire("Éxito","Periodo de matrícula eliminado correctamente","success"),v();else{const c=await r.json();s.fire("Error",c.Mensaje,"error")}}catch(r){console.error("Error al eliminar el periodo de matrícula:",r),s.fire("Error","Error al eliminar el periodo de matrícula","error")}},ae=()=>{const e=new te,a=new Image;a.src=ce,a.onload=()=>{e.addImage(a,"PNG",10,10,30,30),e.setFontSize(18),e.setTextColor(0,102,51),e.text("SAINT PATRICK'S ACADEMY",e.internal.pageSize.width/2,20,{align:"center"}),e.setFontSize(14),e.text("Reporte de Periodos de Matrícula",e.internal.pageSize.width/2,30,{align:"center"}),e.setFontSize(10),e.setTextColor(100),e.text("Casa Club del periodista, Colonia del Periodista",e.internal.pageSize.width/2,40,{align:"center"}),e.text("Teléfono: (504) 2234-8871",e.internal.pageSize.width/2,45,{align:"center"}),e.text("Correo: info@saintpatrickacademy.edu",e.internal.pageSize.width/2,50,{align:"center"}),e.setLineWidth(.5),e.setDrawColor(0,102,51),e.line(10,55,e.internal.pageSize.width-10,55),e.setFontSize(12),e.setTextColor(0,51,102),e.text("Detalles de los Periodos de Matrícula",e.internal.pageSize.width/2,65,{align:"center"}),e.autoTable({startY:75,head:[["#","Fecha Inicio","Fecha Fin","Año Académico","Estado"]],body:_.map((i,A)=>[A+1,i.Fecha_inicio||"N/A",i.Fecha_fin||"N/A",i.Anio_academico||"N/A",i.estado||"N/A"]),styles:{fontSize:10,textColor:[34,34,34],cellPadding:4,valign:"middle",overflow:"linebreak"},headStyles:{fillColor:[0,102,51],textColor:[255,255,255],fontSize:10},alternateRowStyles:{fillColor:[240,248,255]},margin:{left:10,right:10}});const r=e.internal.getNumberOfPages();for(let i=1;i<=r;i++){e.setPage(i);const A=new Date().toLocaleString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});e.setFontSize(10),e.setTextColor(100),e.text(`Fecha y Hora de Generación: ${A}`,10,e.internal.pageSize.height-10),e.text(`Página ${i} de ${r}`,e.internal.pageSize.width-30,e.internal.pageSize.height-10,{align:"right"})}const c=e.output("blob"),x=URL.createObjectURL(c);window.open(x)},a.onerror=()=>{s.fire("Error","No se pudo cargar el logo.","error")}},re=async e=>{try{const a=e.estado==="activo"?"inactivo":"activo",r=await fetch("http://74.50.68.87:4000/api/periodomatricula/estado",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({p_cod_periodo_matricula:e.Cod_periodo_matricula,p_estado:a})});if(!r.ok){const i=await r.json();throw new Error(i.Mensaje||"Error al cambiar el estado del periodo")}const c=await r.json();s.fire("Éxito",c.Mensaje,"success");const x=_.map(i=>i.Cod_periodo_matricula===e.Cod_periodo_matricula?{...i,estado:a}:i);M(x),F(x)}catch(a){console.error("Error al cambiar el estado del periodo:",a),s.fire("Error",a.message,"error")}},ie=()=>{const e=T.json_to_sheet(_.map((r,c)=>({"#":c+1,"Fecha Inicio":r.Fecha_inicio,"Fecha Fin":r.Fecha_fin,"Año Académico":r.Anio_academico,Estado:r.estado}))),a=T.book_new();T.book_append_sheet(a,e,"Periodos de Matrícula"),se(a,"Reporte_Periodos_Matricula.xlsx")};return O?o.jsxs(de,{children:[o.jsxs(Y,{className:"align-items-center mb-5",children:[o.jsx(P,{xs:"8",md:"9",children:o.jsx("h1",{children:"Mantenimiento Periodo Matrícula"})}),o.jsxs(P,{xs:"4",md:"3",className:"text-end",children:[$&&o.jsxs(l,{color:"dark",onClick:()=>f(!0),className:"me-2",style:{backgroundColor:"#4B6251",borderColor:"#0F463A"},children:[o.jsx(m,{icon:me})," Nuevo"]}),o.jsxs(he,{children:[o.jsxs(ue,{style:{backgroundColor:"#6C8E58",borderColor:"#617341"},children:[o.jsx(m,{icon:fe})," Reporte"]}),o.jsxs(pe,{children:[o.jsx(G,{onClick:ae,children:"Exportar a PDF"}),o.jsx(G,{onClick:ie,children:"Exportar a Excel"})]})]})]})]}),o.jsxs(Y,{className:"align-items-center mt-4 mb-2",children:[o.jsx(P,{xs:"12",md:"8",children:o.jsxs(C,{className:"me-3",style:{width:"400px"},children:[o.jsx(j,{children:o.jsx(m,{icon:xe})}),o.jsx(S,{placeholder:"Buscar por estado o año",value:J,onChange:Q}),o.jsxs(l,{style:{border:"1px solid #ccc",backgroundColor:"#F3F4F7",color:"#343a40"},onClick:()=>{D(""),w(1)},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="#E0E0E0"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="#F3F4F7"},children:[o.jsx(m,{icon:Ce})," Limpiar"]})]})}),o.jsx(P,{xs:"12",md:"4",className:"text-md-end mt-2 mt-md-0",children:o.jsx(C,{className:"mt-2 mt-md-0",style:{width:"auto",display:"inline-block"},children:o.jsxs("div",{className:"d-inline-flex align-items-center",children:[o.jsx("span",{children:"Mostrar "}),o.jsxs(H,{style:{width:"80px",display:"inline-block",textAlign:"center"},onChange:e=>{V(Number(e.target.value)),w(1)},value:p,children:[o.jsx("option",{value:"5",children:"5"}),o.jsx("option",{value:"10",children:"10"}),o.jsx("option",{value:"20",children:"20"})]}),o.jsx("span",{children:" registros"})]})})})]}),o.jsx("div",{style:{maxHeight:"400px",overflowY:"auto",overflowX:"hidden"},children:o.jsxs(ge,{striped:!0,bordered:!0,hover:!0,responsive:!0,children:[o.jsx(je,{style:{position:"sticky",top:"0",backgroundColor:"white",zIndex:"1"},children:o.jsxs(N,{children:[o.jsx(g,{children:"#"}),o.jsx(g,{children:"Fecha Inicio"}),o.jsx(g,{children:"Fecha Fin"}),o.jsx(g,{children:"Año Académico"}),o.jsx(g,{children:"Estado"}),o.jsx(g,{children:"Acciones"})]})}),o.jsx(_e,{children:B.length>0?B.map((e,a)=>o.jsxs(N,{children:[o.jsx(h,{children:a+1}),o.jsx(h,{children:e.Fecha_inicio}),o.jsx(h,{children:e.Fecha_fin}),o.jsx(h,{children:e.Anio_academico}),o.jsx(h,{children:o.jsx(l,{color:e.estado==="activo"?"success":"danger",onClick:()=>re(e),style:{opacity:.9},children:e.estado==="activo"?"Desactivar":"Activar"})}),o.jsxs(h,{className:"text-end",children:[q&&o.jsx(l,{color:"warning",className:"me-2",style:{opacity:.8},onClick:()=>ee(e),children:o.jsx(m,{icon:we})}),U&&o.jsx(l,{color:"danger",style:{opacity:.8},onClick:()=>oe(e.Cod_periodo_matricula),children:o.jsx(m,{icon:be})})]})]},e.Cod_periodo_matricula)):o.jsx(N,{children:o.jsx(h,{colSpan:"6",className:"text-center",children:"No hay periodos disponibles"})})})]})}),o.jsxs("div",{className:"pagination-container",style:{display:"flex",justifyContent:"center",alignItems:"center"},children:[o.jsxs(ye,{"aria-label":"Page navigation",children:[o.jsx(l,{style:{backgroundColor:"#6c757d",color:"#fff",marginRight:"0.3cm"},disabled:d===1,onClick:()=>R(d-1),children:"Anterior"}),o.jsx(l,{style:{backgroundColor:"#6c757d",color:"#fff"},disabled:d===Math.ceil(u.length/p),onClick:()=>R(d+1),children:"Siguiente"})]}),o.jsxs("span",{className:"ms-3",children:["Página ",d," de ",Math.ceil(u.length/p)]})]}),o.jsxs(ve,{visible:K,onClose:Z,backdrop:"static",children:[o.jsx(Ee,{children:o.jsx(Fe,{children:y?"Editar Periodo":"Agregar Periodo"})}),o.jsx(Pe,{children:o.jsxs(ke,{onSubmit:y?I:W,children:[o.jsxs(C,{className:"mb-3",children:[o.jsx(j,{children:"Fecha Inicio"}),o.jsx(S,{type:"date",name:"fecha_inicio",value:t.fecha_inicio,onChange:e=>E(e),required:!0})]}),o.jsxs(C,{className:"mb-3",children:[o.jsx(j,{children:"Fecha Fin"}),o.jsx(S,{type:"date",name:"fecha_fin",value:t.fecha_fin,onChange:e=>E(e),required:!0})]}),o.jsxs(C,{className:"mb-3",children:[o.jsx(j,{children:"Año Académico"}),o.jsx(S,{type:"text",name:"anio_academico",value:t.anio_academico,onChange:e=>E(e),required:!0})]}),o.jsxs(C,{className:"mb-3",children:[o.jsx(j,{children:"Estado"}),o.jsxs(H,{name:"estado",value:t.estado,onChange:e=>E(e),required:!0,children:[o.jsx("option",{value:"",children:"Seleccione"}),o.jsx("option",{value:"activo",children:"Activo"}),o.jsx("option",{value:"inactivo",children:"Inactivo"})]})]}),o.jsxs(Se,{children:[o.jsx(l,{style:{backgroundColor:"#6c757d",color:"white",borderColor:"#6c757d"},onClick:()=>f(!1),children:"Cancelar"}),o.jsxs(l,{style:{backgroundColor:"#4B6251",color:"white",borderColor:"#4B6251"},type:"submit",children:[o.jsx(m,{icon:Ae})," ","Guardar"]})]})]})})]})]}):o.jsx(le,{})};export{ho as default};
